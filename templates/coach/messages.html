{% extends "base.html" %}

{% block title %}Messages - PowerFit{% endblock %}

{% block content %}
<div class="container mx-auto py-8">
 <h2 class="text-lg sm:text-xl lg:text-2xl font-bold mb-4">Messages (Coach)</h2>
 <div class="flex">
 <!-- Contacts List -->
 <div class="w-1/3 border-r pr-4">
 <h3 class="font-semibold mb-2">Contacts</h3>
 <form method="get" action="/coach/messages" class="mb-2">
 <input type="text" name="search" value="{{ request.query_params.get('search', '') }}" placeholder="Search contacts..." class="w-full border rounded px-2 py-1" />
 {% if contact_id and contact_type %}
 <input type="hidden" name="contact_id" value="{{ contact_id }}">
 <input type="hidden" name="contact_type" value="{{ contact_type }}">
 {% endif %}
 <button type="submit" class="mt-1 w-full bg-indigo-500 text-white rounded px-2 py-1">Search</button>
 </form>
 <ul class="space-y-2">
 {% for contact in contacts %}
 <li>
 <a href="/coach/messages?contact_id={{ contact.id }}&contact_type={{ contact.type }}{% if request.query_params.get('search') %}&search={{ request.query_params.get('search') }}{% endif %}" class="block px-2 py-1 rounded {{ 'bg-indigo-100 font-bold' if contact_id==contact.id and contact_type==contact.type else 'hover:bg-gray-100' }}">
 {{ contact.name }} ({{ contact.type|capitalize }})
 </a>
 </li>
 {% endfor %}
 </ul>
 </div>
 <!-- Message Area -->
 <div class="w-2/3 pl-4">
 {% if selected_contact %}
 <h4 class="font-semibold mb-2">Conversation with {{ selected_contact.name }} ({{ selected_contact.type|capitalize }})</h4>
 
 <!-- Success/Error Messages -->
 {% if request.query_params.get('success') %}
 <div class="mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded">
   {% if request.query_params.get('success') == 'message_sent' %}
     Message sent successfully!
   {% elif request.query_params.get('success') == 'message_deleted' %}
     Message deleted successfully!
   {% endif %}
 </div>
 {% endif %}
 
 {% if request.query_params.get('error') %}
 <div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
   {% if request.query_params.get('error') == 'empty_message' %}
     Message cannot be empty.
   {% elif request.query_params.get('error') == 'message_too_long' %}
     Message is too long (max 1000 characters).
   {% elif request.query_params.get('error') == 'send_failed' %}
     Failed to send message. Please try again.
   {% elif request.query_params.get('error') == 'delete_failed' %}
     Failed to delete message. Please try again.
   {% elif request.query_params.get('error') == 'unauthorized_delete' %}
     You can only delete your own messages.
   {% elif request.query_params.get('error') == 'message_not_found' %}
     Message not found.
   {% else %}
     An error occurred. Please try again.
   {% endif %}
 </div>
 {% endif %}
 <div class="border rounded-lg p-4 bg-gray-50 mb-4 max-h-96 overflow-y-auto">
 {% for message in messages %}
 <div class="mb-2 p-2 rounded {{ 'bg-blue-100 text-right' if message.sender_id==user.id else 'bg-white text-left' }}">
 <div class="flex justify-between items-start">
   <div class="flex-1">
     <strong>{{ message.sender_name }}:</strong> {{ message.message }}
     <div class="text-xs text-gray-500 mt-1">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
   </div>
   {% if message.sender_id == user.id %}
   <form method="post" action="/coach/messages/delete/{{ message.id }}" class="ml-2">
     <input type="hidden" name="contact_id" value="{{ contact_id }}">
     <input type="hidden" name="contact_type" value="{{ contact_type }}">
     {% if request.query_params.get('search') %}
     <input type="hidden" name="search" value="{{ request.query_params.get('search') }}">
     {% endif %}
     <button type="submit" class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded hover:bg-red-50 transition-colors" onclick="return confirm('Are you sure you want to delete this message?')">
       <i class="fas fa-trash"></i> Delete
     </button>
   </form>
   {% endif %}
 </div>
 </div>
 {% else %}
 <p class="text-gray-500">No messages yet. Start the conversation!</p>
 {% endfor %}
 </div>
 <!-- Message input form -->
 <form method="post" action="/coach/messages">
 <input type="hidden" name="contact_id" value="{{ contact_id }}">
 <input type="hidden" name="contact_type" value="{{ contact_type }}">
 {% if request.query_params.get('search') %}
 <input type="hidden" name="search" value="{{ request.query_params.get('search') }}">
 {% endif %}
 <div class="flex">
 <input type="text" name="message" placeholder="Type your message..." class="flex-1 border rounded-l px-3 py-2" required />
 <button type="submit" class="bg-indigo-500 text-white px-4 py-2 rounded-r">Send</button>
 </div>
 </form>
 {% else %}
 <p class="text-gray-500">Select a contact to start messaging.</p>
 {% endif %}
 </div>
 </div>
</div>
{% endblock %}

{% block scripts %}
{% endblock %} 