{% extends "base.html" %}

{% block extra_head %}
<!-- Chart.js for nutrition analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Ensure Chart.js is loaded before using it
window.addEventListener('load', function() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js failed to load');
    } else {
        console.log('Chart.js loaded successfully');
    }
});
</script>
<style>
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    overflow: hidden;
}
.chart-container canvas {
    max-height: 100%;
    max-width: 100%;
}
</style>
{% endblock %}

{% block content_title %}
<div class="flex items-center justify-between">
    <div class="flex items-center space-x-3">
        <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-400 to-teal-500 text-white shadow-lg">
            <i class="fas fa-apple-alt text-xl"></i>
        </div>
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Nutrition Management</h1>
            <p class="text-gray-600 text-sm sm:text-base">Monitor and guide member nutrition progress</p>
        </div>
    </div>
    <div class="hidden sm:flex items-center space-x-2">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gradient-to-r from-emerald-400 to-teal-400 text-white shadow-sm">
            <i class="fas fa-chart-line mr-1"></i>Analytics
        </span>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Overview Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="glass rounded-xl p-6 border border-emerald-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Members</p>
                    <p class="text-2xl font-bold text-gray-900" id="totalMembers">{{ stats.total_members if stats else 0 }}</p>
                </div>
                <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-emerald-100 text-emerald-600">
                    <i class="fas fa-users text-xl"></i>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl p-6 border border-blue-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Active Nutrition</p>
                    <p class="text-2xl font-bold text-gray-900" id="activeNutrition">{{ stats.members_with_nutrition if stats else 0 }}</p>
                </div>
                <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-blue-100 text-blue-600">
                    <i class="fas fa-apple-alt text-xl"></i>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl p-6 border border-orange-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Entries</p>
                    <p class="text-2xl font-bold text-gray-900" id="totalEntries">{{ stats.total_nutrition_entries if stats else 0 }}</p>
                </div>
                <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-orange-100 text-orange-600">
                    <i class="fas fa-clipboard-list text-xl"></i>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl p-6 border border-purple-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Avg Calories</p>
                    <p class="text-2xl font-bold text-gray-900" id="avgCalories">{{ "%.0f"|format(stats.avg_calories) if stats and stats.avg_calories else 0 }}</p>
                </div>
                <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-purple-100 text-purple-600">
                    <i class="fas fa-fire text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Nutrition Overview -->
    <div class="glass rounded-xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-users text-emerald-600 mr-2"></i>
                Member Nutrition Overview
            </h2>
            <div class="flex items-center space-x-2">
                <button onclick="refreshNutritionData()" 
                        class="bg-emerald-600 text-white px-3 py-2 rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
                <button onclick="exportNutrition('xlsx')" 
                        class="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    <i class="fas fa-file-excel mr-2"></i>Export Excel
                </button>
                <button onclick="toggleFilters()" 
                        class="bg-gray-600 text-white px-3 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                    <i class="fas fa-filter mr-2"></i>Filters
                </button>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div id="filterSection" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Search Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Members</label>
                    <input type="text" id="memberSearchFilter" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                           placeholder="Search by name or email...">
                </div>
                
                <!-- Activity Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Activity Status</label>
                    <select id="activityFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option value="all">All Members</option>
                        <option value="active">Active (Logged recently)</option>
                        <option value="inactive">Inactive (No recent logs)</option>
                        <option value="never">Never Logged</option>
                    </select>
                </div>
                
                <!-- Time Range Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Range</label>
                    <select id="timeRangeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option value="all">All Time</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                
                <!-- Sort By Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                    <select id="sortFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <option value="name">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                        <option value="entries">Most Entries</option>
                        <option value="entries-asc">Least Entries</option>
                        <option value="calories">Highest Calories</option>
                        <option value="calories-asc">Lowest Calories</option>
                        <option value="last-entry">Most Recent Entry</option>
                        <option value="last-entry-desc">Oldest Entry</option>
                    </select>
                </div>
            </div>
            
            <!-- Filter Actions -->
            <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                <div class="flex items-center space-x-2">
                    <button onclick="applyFilters()" 
                            class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-colors">
                        <i class="fas fa-check mr-2"></i>Apply Filters
                    </button>
                    <button onclick="clearFilters()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                        <i class="fas fa-times mr-2"></i>Clear Filters
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    <span id="filterResults">Showing all members</span>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entries</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Calories</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Protein</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Entry</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="membersTable">
                    <!-- Members will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Nutrition Entries -->
    <div class="glass rounded-xl p-6 border border-gray-100">
        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-clock text-emerald-600 mr-2"></i>
            Recent Nutrition Entries
        </h2>
        
        <div class="space-y-4" id="recentEntries">
            <!-- Recent entries will be loaded here -->
        </div>
    </div>

    <!-- Nutrition Analytics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Meal Type Distribution -->
        <div class="glass rounded-xl p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Meal Type Distribution</h3>
            <div class="chart-container">
                <canvas id="mealTypeChart"></canvas>
            </div>
        </div>
        
        <!-- Macronutrient Distribution -->
        <div class="glass rounded-xl p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Macronutrient Distribution</h3>
            <div class="chart-container">
                <canvas id="macroNutrientChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Nutrition Plans -->
    <div class="glass rounded-xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-clipboard-list text-emerald-600 mr-2"></i>
                Nutrition Plans
            </h2>
            <div class="flex items-center space-x-2">
                <button onclick="viewAllNutritionPlans()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all">
                    <i class="fas fa-clipboard-list mr-2"></i>View All Plans
                </button>
                <button onclick="openCreatePlanModal()" class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all">
                    <i class="fas fa-plus mr-2"></i>Create Plan
                </button>
            </div>
        </div>

        <div id="nutritionPlans">
            <!-- Nutrition plans will be loaded here -->
        </div>
    </div>
</div>

<!-- Create Nutrition Plan Modal -->
<div id="createPlanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Create Nutrition Plan</h3>
                <button onclick="closeModal('createPlanModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="createPlanForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Member</label>
                        
                        <!-- Search and Filter Bar -->
                        <div class="mb-4">
                            <div class="relative">
                                <input type="text" id="memberSearch" 
                                       class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                       placeholder="Search members by name...">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Member Selection Cards -->
                        <div id="memberSelectionCards" class="max-h-64 overflow-y-auto space-y-2">
                            <!-- Member cards will be loaded here -->
                        </div>
                        
                        <!-- Hidden input to store selected member -->
                        <input type="hidden" name="member_id" id="selectedMemberId" required>
                        
                        <!-- Selected Member Display -->
                        <div id="selectedMemberDisplay" class="hidden mt-3 p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 id="selectedMemberName" class="font-medium text-gray-900"></h4>
                                    <p id="selectedMemberEmail" class="text-sm text-gray-600"></p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button type="button" onclick="changeMemberSelection()" class="text-emerald-600 hover:text-emerald-800 text-sm font-medium">
                                        <i class="fas fa-edit mr-1"></i>Change
                                    </button>
                                    <button type="button" onclick="clearMemberSelection()" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Plan Name</label>
                        <input type="text" name="plan_name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                               placeholder="e.g., Weight Loss Plan">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daily Calories</label>
                            <input type="number" name="daily_calories" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                   placeholder="2000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daily Protein (g)</label>
                            <input type="number" name="daily_protein" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                   placeholder="150">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daily Carbs (g)</label>
                            <input type="number" name="daily_carbs" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                   placeholder="250">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daily Fat (g)</label>
                            <input type="number" name="daily_fat" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                   placeholder="70">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea name="notes" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                  placeholder="Additional notes about the nutrition plan..."></textarea>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="closeModal('createPlanModal')" 
                                class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all">
                            <i class="fas fa-save mr-2"></i>Create Plan
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Member Nutrition Details Modal -->
<div id="memberDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Member Nutrition Details</h3>
                <button onclick="closeModal('memberDetailsModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="memberDetailsContent">
                <!-- Member details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Member Nutrition Plans Modal -->
<div id="memberPlansModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Member Nutrition Plans</h3>
                <button onclick="closeModal('memberPlansModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="memberPlansContent">
                <!-- Member nutrition plans will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- All Nutrition Plans Modal -->
<div id="allPlansModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">All Member Nutrition Plans</h3>
                <button onclick="closeModal('allPlansModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="allPlansContent">
                <!-- All nutrition plans will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Coach Comparison Modal -->
<div id="coachComparisonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Member Plan vs Today Comparison</h3>
                <button onclick="closeModal('coachComparisonModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="coachComparisonContent">
                <!-- Coach comparison data will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Nutrition Plan Modal -->
<div id="editPlanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Edit Nutrition Plan</h3>
                <button onclick="closeModal('editPlanModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editPlanForm" class="space-y-6">
                <input type="hidden" id="editPlanId">
                
                <div>
                    <label for="editPlanName" class="block text-sm font-medium text-gray-700 mb-2">Plan Name</label>
                    <input type="text" id="editPlanName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="editDailyCalories" class="block text-sm font-medium text-gray-700 mb-2">Daily Calories</label>
                        <input type="number" id="editDailyCalories" required min="1000" max="5000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label for="editDailyProtein" class="block text-sm font-medium text-gray-700 mb-2">Daily Protein (g)</label>
                        <input type="number" id="editDailyProtein" required min="20" max="300" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="editDailyCarbs" class="block text-sm font-medium text-gray-700 mb-2">Daily Carbs (g)</label>
                        <input type="number" id="editDailyCarbs" required min="50" max="500" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label for="editDailyFat" class="block text-sm font-medium text-gray-700 mb-2">Daily Fat (g)</label>
                        <input type="number" id="editDailyFat" required min="20" max="200" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                </div>
                
                <div>
                    <label for="editPlanNotes" class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                    <textarea id="editPlanNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                </div>
                
                <div class="flex items-center justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('editPlanModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium">
                        Update Plan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables
let nutritionData = null;
let mealTypeChart = null;
let macroNutrientChart = null;
let nutritionAllMembers = []; // Store all members for filtering
let nutritionFilteredMembers = []; // Store filtered members

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Show loading state
    showLoadingState();
    
    // Load all required data
    Promise.all([
        loadNutritionDashboard(),
        loadMembers(),
        loadAnalytics(),
        loadCoachSidebarStats()
    ]).then(() => {
        hideLoadingState();
    }).catch((error) => {
        console.error('Error during initialization:', error);
        hideLoadingState();
    });
    
    // Refresh data every 5 minutes
    setInterval(() => {
        loadNutritionDashboard();
        loadAnalytics();
    }, 5 * 60 * 1000);
    
    // Add real-time search functionality
    const memberSearchFilter = document.getElementById('memberSearchFilter');
    if (memberSearchFilter) {
        memberSearchFilter.addEventListener('input', function() {
            // Debounce the search to avoid too many filter operations
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                applyFilters();
            }, 300);
        });
    }
});

// Show loading state
function showLoadingState() {
    const statsElements = ['totalMembers', 'activeNutrition', 'totalEntries', 'avgCalories'];
    statsElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = '...';
        }
    });
    
    const recentEntries = document.getElementById('recentEntries');
    if (recentEntries) {
        recentEntries.innerHTML = `
            <div class="text-center py-8">
                <div class="w-8 h-8 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-600">Loading recent entries...</p>
            </div>
        `;
    }
}

// Hide loading state
function hideLoadingState() {
    // Loading states will be replaced by actual data
}

// Load nutrition dashboard data
async function loadNutritionDashboard() {
    try {
        const response = await fetch('/api/coach/nutrition/dashboard');
        const data = await response.json();
        
        console.log('Nutrition dashboard response:', data);
        
        if (data.success) {
            nutritionData = data;
            
            // Update dashboard stats
            if (data.stats) {
                updateDashboardStats(data.stats);
            } else if (data.dashboard_stats) {
                updateDashboardStats(data.dashboard_stats);
            } else {
                console.warn('No stats data found in dashboard response');
            }
            
            // Update recent entries
            if (data.recent_entries) {
                updateRecentEntries(data.recent_entries);
            } else if (data.latest_entries) {
                updateRecentEntries(data.latest_entries);
            } else {
                console.warn('No recent entries found in dashboard response');
            }
            
            // Update analytics
            updateAnalytics(data);
            
        } else {
            console.error('Dashboard request failed:', data);
            showNotification(data.detail || 'Failed to load nutrition dashboard', 'error');
        }
    } catch (error) {
        console.error('Error loading nutrition dashboard:', error);
        showNotification('Error loading nutrition dashboard data', 'error');
    }
}

// Load members with nutrition data
async function loadMembers() {
    try {
        const response = await fetch('/api/coach/nutrition/members');
        const data = await response.json();
        
        console.log('Members response:', data);
        
        if (data.success) {
            nutritionAllMembers = data.members || [];
            nutritionFilteredMembers = nutritionAllMembers;
            updateMembersTable(nutritionAllMembers);
            updateFilterResults(nutritionAllMembers.length, nutritionAllMembers.length);
        } else {
            console.error('Members request failed:', data);
            nutritionAllMembers = [];
            nutritionFilteredMembers = [];
            updateMembersTable([]);
            updateFilterResults(0, 0);
        }
    } catch (error) {
        console.error('Error loading members:', error);
        nutritionAllMembers = [];
        nutritionFilteredMembers = [];
        updateMembersTable([]);
        updateFilterResults(0, 0);
    }
}

// Load recent nutrition entries
async function loadRecentEntries() {
    try {
        // Use the dashboard endpoint which includes recent entries
        const response = await fetch('/api/coach/nutrition/dashboard');
        const data = await response.json();
        
        console.log('Recent entries response:', data);
        
        if (data.success && data.recent_entries) {
            updateRecentEntries(data.recent_entries);
        } else {
            console.error('Recent entries request failed:', data);
            // Show empty state if no data
            updateRecentEntries([]);
        }
    } catch (error) {
        console.error('Error loading recent entries:', error);
        // Show empty state on error
        updateRecentEntries([]);
    }
}

// Load analytics
async function loadAnalytics() {
    try {
        const timeRange = document.getElementById('timeRangeFilter').value;
        console.log('Loading analytics for time range:', timeRange);
        
        const response = await fetch(`/api/coach/nutrition/analytics?time_range=${timeRange}`);
        const data = await response.json();
        
        console.log('Analytics response:', data);
        
        if (data.success) {
            updateAnalytics(data);
        } else {
            console.error('Analytics request failed:', data);
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
    }
}

// Update dashboard statistics
function updateDashboardStats(stats) {
    if (stats) {
        // Total Members - count of all members assigned to this coach
        const totalMembers = stats.total_members || stats.total_coach_members || 0;
        document.getElementById('totalMembers').textContent = totalMembers;
        
        // Active Nutrition - members who have logged nutrition entries
        const activeNutrition = stats.members_with_nutrition || stats.active_nutrition_members || 0;
        document.getElementById('activeNutrition').textContent = activeNutrition;
        
        // Total Entries - total number of nutrition entries across all members
        const totalEntries = stats.total_nutrition_entries || stats.total_entries || 0;
        document.getElementById('totalEntries').textContent = totalEntries;
        
        // Average Calories - average calories per entry or per member
        const avgCalories = stats.avg_calories || stats.average_calories || 0;
        document.getElementById('avgCalories').textContent = Math.round(avgCalories);
        
        console.log('Updated dashboard stats:', {
            totalMembers,
            activeNutrition,
            totalEntries,
            avgCalories
        });
    } else {
        console.warn('No stats data provided to updateDashboardStats');
    }
}

// Update members table
function updateMembersTable(members) {
    const tbody = document.getElementById('membersTable');
    
    if (!members || members.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                    No members with nutrition data found
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = members.map(member => {
        const fullName = member.name || 'Unknown Member';
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <div class="h-10 w-10 rounded-full bg-emerald-100 flex items-center justify-center">
                                <i class="fas fa-user text-emerald-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${fullName}</div>
                            <div class="text-sm text-gray-500">${member.email || 'No email'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${member.nutrition_entries || 0}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${Math.round(member.avg_calories || 0)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${Math.round(member.avg_protein || 0)}g
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${member.last_nutrition_entry ? new Date(member.last_nutrition_entry).toLocaleDateString() : 'Never'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewMemberNutrition(${member.id})" class="text-emerald-600 hover:text-emerald-900 mr-3" title="View Nutrition Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="viewMemberPlans(${member.id})" class="text-purple-600 hover:text-purple-900 mr-3" title="View Nutrition Plans">
                        <i class="fas fa-clipboard-list"></i>
                    </button>

                </td>
            </tr>
        `;
    }).join('');
}

// Update recent entries
function updateRecentEntries(entries) {
    const container = document.getElementById('recentEntries');
    
    if (!entries || entries.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-clipboard-list text-4xl mb-2 opacity-50"></i>
                <p>No recent nutrition entries</p>
                <p class="text-sm text-gray-400 mt-2">Members haven't logged any meals yet</p>
            </div>
        `;
        return;
    }
    
    // Ensure we only show the latest 5 entries and sort by date
    const recentEntries = entries
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 5);
    
    container.innerHTML = recentEntries.map(entry => {
        const fullName = entry.name || entry.member_name || 'Unknown Member';
        const foodName = entry.food_name || entry.food_item || 'Unknown Food';
        const mealType = entry.meal_type || 'Unknown';
        const calories = Math.round(entry.calories || 0);
        const protein = Math.round(entry.protein || 0);
        const carbs = Math.round(entry.carbs || 0);
        const fat = Math.round(entry.fat || 0);
        const date = entry.created_at ? new Date(entry.created_at) : null;
        
        return `
            <div class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center">
                        <i class="fas ${getMealIcon(mealType)}"></i>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900">${fullName}</h4>
                        <p class="text-sm text-gray-600">${foodName} (${mealType})</p>
                        ${entry.quantity ? `<p class="text-xs text-gray-500">${entry.quantity}${entry.unit || ''}</p>` : ''}
                    </div>
                </div>
                <div class="text-right text-sm text-gray-600">
                    <div class="font-semibold text-gray-900">${calories} calories</div>
                    <div class="text-xs">
                        <span class="text-blue-600">P: ${protein}g</span> • 
                        <span class="text-green-600">C: ${carbs}g</span> • 
                        <span class="text-orange-600">F: ${fat}g</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${date ? date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Unknown date'}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Update analytics
function updateAnalytics(data) {
    console.log('Updating analytics with data:', data);
    
    // Handle different possible data structures for meal distribution
    let mealDistribution = null;
    
    if (data.meal_distribution && data.meal_distribution.length > 0) {
        mealDistribution = data.meal_distribution;
    } else if (data.analytics && data.analytics.meal_distribution) {
        mealDistribution = data.analytics.meal_distribution;
    } else if (data.meal_type_distribution) {
        mealDistribution = data.meal_type_distribution;
    }
    
    // Create meal type distribution chart
    if (mealDistribution && mealDistribution.length > 0) {
        createMealTypeChart(mealDistribution);
    } else {
        console.log('No meal distribution data available - showing default chart');
        createDefaultMealTypeChart();
    }
    
    // Handle macronutrient data
    let macroData = null;
    
    if (data.recent_entries && data.recent_entries.length > 0) {
        macroData = data.recent_entries;
    } else if (data.nutrition_entries && data.nutrition_entries.length > 0) {
        macroData = data.nutrition_entries;
    } else if (data.analytics && data.analytics.nutrition_entries) {
        macroData = data.analytics.nutrition_entries;
    }
    
    // Create macronutrient distribution chart
    if (macroData && macroData.length > 0) {
        createMacroNutrientChart(macroData);
    } else {
        console.log('No macronutrient data available - showing default chart');
        createDefaultMacroNutrientChart();
    }
}

// Create default meal type distribution chart
function createDefaultMealTypeChart() {
    const ctx = document.getElementById('mealTypeChart');
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    // Destroy existing chart if it exists
    if (mealTypeChart) {
        mealTypeChart.destroy();
        mealTypeChart = null;
    }
    
    ctx.style.display = 'block';
    
    // Ensure the canvas has proper dimensions
    const container = ctx.parentElement;
    ctx.width = container.offsetWidth;
    ctx.height = container.offsetHeight;
    
    // Default nutrition distribution data (typical balanced diet)
    const defaultData = [
        { label: 'Breakfast', value: 25, color: '#10b981' },
        { label: 'Lunch', value: 30, color: '#3b82f6' },
        { label: 'Dinner', value: 30, color: '#f59e0b' },
        { label: 'Snacks', value: 15, color: '#ef4444' }
    ];
    
    const chartLabels = defaultData.map(item => item.label);
    const chartData = defaultData.map(item => item.value);
    const colors = defaultData.map(item => item.color);
    
    console.log('Creating default chart with data:', { chartLabels, chartData });
    
    mealTypeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartLabels,
            datasets: [{
                data: chartData,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.parsed}% (Recommended)`;
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Recommended Nutrition Distribution',
                    font: {
                        size: 14,
                        weight: 'bold'
                    },
                    padding: {
                        top: 10,
                        bottom: 20
                    }
                }
            },
            elements: {
                arc: {
                    borderWidth: 2
                }
            }
        }
    });
    
    // Add a note below the chart
    const chartContainer = ctx.parentElement;
    const noteElement = document.createElement('div');
    noteElement.className = 'text-center mt-4 text-sm text-gray-500';
    noteElement.innerHTML = `
        <i class="fas fa-info-circle mr-1"></i>
        This shows the recommended nutrition distribution. Actual data will appear when members log their meals.
    `;
    
    // Remove any existing note
    const existingNote = chartContainer.querySelector('.text-center.mt-4');
    if (existingNote) {
        existingNote.remove();
    }
    
    chartContainer.appendChild(noteElement);
}

// Filter Functions
function toggleFilters() {
    const filterSection = document.getElementById('filterSection');
    const filterButton = document.querySelector('button[onclick="toggleFilters()"]');
    
    if (filterSection.classList.contains('hidden')) {
        filterSection.classList.remove('hidden');
        filterButton.innerHTML = '<i class="fas fa-filter mr-2"></i>Hide Filters';
        filterButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        filterButton.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
    } else {
        filterSection.classList.add('hidden');
        filterButton.innerHTML = '<i class="fas fa-filter mr-2"></i>Filters';
        filterButton.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
        filterButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
    }
}

function applyFilters() {
    const searchTerm = document.getElementById('memberSearchFilter').value.toLowerCase();
    const activityFilter = document.getElementById('activityFilter').value;
    const timeRangeFilter = document.getElementById('timeRangeFilter').value;
    const sortFilter = document.getElementById('sortFilter').value;
    
    // Filter members based on search term
    let filtered = nutritionAllMembers.filter(member => {
        const name = (member.name || '').toLowerCase();
        const email = (member.email || '').toLowerCase();
        return name.includes(searchTerm) || email.includes(searchTerm);
    });
    
    // Filter by activity status
    if (activityFilter !== 'all') {
        const now = new Date();
        const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        filtered = filtered.filter(member => {
            if (activityFilter === 'active') {
                return member.last_nutrition_entry && new Date(member.last_nutrition_entry) > oneWeekAgo;
            } else if (activityFilter === 'inactive') {
                return member.last_nutrition_entry && new Date(member.last_nutrition_entry) <= oneWeekAgo;
            } else if (activityFilter === 'never') {
                return !member.last_nutrition_entry;
            }
            return true;
        });
    }
    
    // Sort members
    filtered.sort((a, b) => {
        switch (sortFilter) {
            case 'name':
                return (a.name || '').localeCompare(b.name || '');
            case 'name-desc':
                return (b.name || '').localeCompare(a.name || '');
            case 'entries':
                return (b.nutrition_entries || 0) - (a.nutrition_entries || 0);
            case 'entries-asc':
                return (a.nutrition_entries || 0) - (b.nutrition_entries || 0);
            case 'calories':
                return (b.avg_calories || 0) - (a.avg_calories || 0);
            case 'calories-asc':
                return (a.avg_calories || 0) - (b.avg_calories || 0);
            case 'last-entry':
                if (!a.last_nutrition_entry && !b.last_nutrition_entry) return 0;
                if (!a.last_nutrition_entry) return 1;
                if (!b.last_nutrition_entry) return -1;
                return new Date(b.last_nutrition_entry) - new Date(a.last_nutrition_entry);
            case 'last-entry-desc':
                if (!a.last_nutrition_entry && !b.last_nutrition_entry) return 0;
                if (!a.last_nutrition_entry) return 1;
                if (!b.last_nutrition_entry) return -1;
                return new Date(a.last_nutrition_entry) - new Date(b.last_nutrition_entry);
            default:
                return 0;
        }
    });
    
    nutritionFilteredMembers = filtered;
    updateMembersTable(filtered);
    updateFilterResults(filtered.length, nutritionAllMembers.length);
}

function clearFilters() {
    document.getElementById('memberSearchFilter').value = '';
    document.getElementById('activityFilter').value = 'all';
    document.getElementById('timeRangeFilter').value = 'all';
    document.getElementById('sortFilter').value = 'name';
    
    nutritionFilteredMembers = nutritionAllMembers;
    updateMembersTable(nutritionAllMembers);
    updateFilterResults(nutritionAllMembers.length, nutritionAllMembers.length);
}

function updateFilterResults(filteredCount, totalCount) {
    const filterResults = document.getElementById('filterResults');
    if (filteredCount === totalCount) {
        filterResults.textContent = `Showing all ${totalCount} members`;
    } else {
        filterResults.textContent = `Showing ${filteredCount} of ${totalCount} members`;
    }
}

// Create default macronutrient distribution chart
function createDefaultMacroNutrientChart() {
    const ctx = document.getElementById('macroNutrientChart');
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    // Destroy existing chart if it exists
    if (macroNutrientChart) {
        macroNutrientChart.destroy();
        macroNutrientChart = null;
    }
    
    ctx.style.display = 'block';
    
    // Ensure the canvas has proper dimensions
    const container = ctx.parentElement;
    ctx.width = container.offsetWidth;
    ctx.height = container.offsetHeight;
    
    // Default macronutrient distribution data (balanced diet)
    const defaultData = [
        { label: 'Protein', value: 25, color: '#3b82f6' },
        { label: 'Carbohydrates', value: 50, color: '#10b981' },
        { label: 'Fat', value: 25, color: '#f59e0b' }
    ];
    
    const chartLabels = defaultData.map(item => item.label);
    const chartData = defaultData.map(item => item.value);
    const colors = defaultData.map(item => item.color);
    
    console.log('Creating default macronutrient chart with data:', { chartLabels, chartData });
    
    macroNutrientChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartLabels,
            datasets: [{
                data: chartData,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.parsed}% (Recommended)`;
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Recommended Macronutrient Distribution',
                    font: {
                        size: 14,
                        weight: 'bold'
                    },
                    padding: {
                        top: 10,
                        bottom: 20
                    }
                }
            },
            elements: {
                arc: {
                    borderWidth: 2
                }
            }
        }
    });
    
    // Add a note below the chart
    const chartContainer = ctx.parentElement;
    const noteElement = document.createElement('div');
    noteElement.className = 'text-center mt-4 text-sm text-gray-500';
    noteElement.innerHTML = `
        <i class="fas fa-info-circle mr-1"></i>
        This shows the recommended macronutrient distribution. Actual data will appear when members log their meals.
    `;
    
    // Remove any existing note
    const existingNote = chartContainer.querySelector('.text-center.mt-4');
    if (existingNote) {
        existingNote.remove();
    }
    
    chartContainer.appendChild(noteElement);
}

// Create macronutrient distribution chart
function createMacroNutrientChart(macroData) {
    const ctx = document.getElementById('macroNutrientChart');
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    // Destroy existing chart if it exists
    if (macroNutrientChart) {
        macroNutrientChart.destroy();
        macroNutrientChart = null;
    }
    
    // Check if we have data
    if (!macroData || macroData.length === 0) {
        console.log('No macronutrient data available - showing default chart');
        createDefaultMacroNutrientChart();
        return;
    }
    
    ctx.style.display = 'block';
    
    // Ensure the canvas has proper dimensions
    const container = ctx.parentElement;
    ctx.width = container.offsetWidth;
    ctx.height = container.offsetHeight;
    
    // Process macronutrient data
    const totalProtein = macroData.reduce((sum, item) => sum + (item.protein || 0), 0);
    const totalCarbs = macroData.reduce((sum, item) => sum + (item.carbs || 0), 0);
    const totalFat = macroData.reduce((sum, item) => sum + (item.fat || 0), 0);
    const total = totalProtein + totalCarbs + totalFat;
    
    if (total === 0) {
        console.log('No valid macronutrient data - showing default chart');
        createDefaultMacroNutrientChart();
        return;
    }
    
    const proteinPercent = Math.round((totalProtein / total) * 100);
    const carbsPercent = Math.round((totalCarbs / total) * 100);
    const fatPercent = Math.round((totalFat / total) * 100);
    
    const chartData = [
        { label: 'Protein', value: proteinPercent, color: '#3b82f6' },
        { label: 'Carbohydrates', value: carbsPercent, color: '#10b981' },
        { label: 'Fat', value: fatPercent, color: '#f59e0b' }
    ];
    
    const chartLabels = chartData.map(item => item.label);
    const chartValues = chartData.map(item => item.value);
    const colors = chartData.map(item => item.color);
    
    console.log('Creating macronutrient chart with data:', { chartLabels, chartValues });
    
    macroNutrientChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartLabels,
            datasets: [{
                data: chartValues,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.parsed}% (Actual)`;
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Actual Macronutrient Distribution',
                    font: {
                        size: 14,
                        weight: 'bold'
                    },
                    padding: {
                        top: 10,
                        bottom: 20
                    }
                }
            },
            elements: {
                arc: {
                    borderWidth: 2
                }
            }
        }
    });
    
    // Remove any existing note when showing actual data
    const chartContainer = ctx.parentElement;
    const existingNote = chartContainer.querySelector('.text-center.mt-4');
    if (existingNote) {
        existingNote.remove();
    }
}

// Create meal type distribution chart
function createMealTypeChart(mealDistribution) {
    const ctx = document.getElementById('mealTypeChart');
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    // Destroy existing chart if it exists
    if (mealTypeChart) {
        mealTypeChart.destroy();
        mealTypeChart = null;
    }
    
    // Check if we have data
    if (!mealDistribution || mealDistribution.length === 0) {
        console.log('No meal distribution data available - showing default chart');
        createDefaultMealTypeChart();
        return;
    }
    
    ctx.style.display = 'block';
    
    // Ensure the canvas has proper dimensions
    const container = ctx.parentElement;
    ctx.width = container.offsetWidth;
    ctx.height = container.offsetHeight;
    
    // Handle different data formats
    let labels = [];
    let data = [];
    
    if (Array.isArray(mealDistribution)) {
        labels = mealDistribution.map(item => {
            // Handle different possible field names
            return item.meal_type || item.type || item.name || 'Unknown';
        });
        data = mealDistribution.map(item => {
            // Handle different possible field names
            return item.count || item.entries || item.value || 0;
        });
    } else if (typeof mealDistribution === 'object') {
        // If it's an object with meal types as keys
        labels = Object.keys(mealDistribution);
        data = Object.values(mealDistribution);
    }
    
    // Filter out zero values and ensure we have valid data
    const validData = labels.map((label, index) => ({
        label: label,
        value: data[index] || 0
    })).filter(item => item.value > 0);
    
    if (validData.length === 0) {
        console.log('No valid meal distribution data - showing default chart');
        createDefaultMealTypeChart();
        return;
    }
    
    const chartLabels = validData.map(item => item.label);
    const chartData = validData.map(item => item.value);
    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#8b5cf6', '#f97316'];
    
    console.log('Creating chart with data:', { chartLabels, chartData });
    
    mealTypeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartLabels,
            datasets: [{
                data: chartData,
                backgroundColor: colors.slice(0, chartData.length),
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 10,
                    bottom: 10
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Actual Meal Distribution',
                    font: {
                        size: 14,
                        weight: 'bold'
                    },
                    padding: {
                        top: 10,
                        bottom: 20
                    }
                }
            },
            elements: {
                arc: {
                    borderWidth: 2
                }
            }
        }
    });
    
    // Remove any existing note when showing actual data
    const chartContainer = ctx.parentElement;
    const existingNote = chartContainer.querySelector('.text-center.mt-4');
    if (existingNote) {
        existingNote.remove();
    }
}



// View member nutrition details
async function viewMemberNutrition(memberId) {
    try {
        const response = await fetch(`/api/coach/nutrition/member/${memberId}`);
        const data = await response.json();
        
        if (data.success) {
            showMemberDetails(data);
        }
    } catch (error) {
        console.error('Error loading member nutrition:', error);
    }
}

// View member nutrition plans
async function viewMemberPlans(memberId) {
    try {
        // Store the current member ID for use in other functions
        currentMemberId = memberId;
        
        const response = await fetch(`/api/coach/nutrition/plans/${memberId}`);
        const data = await response.json();
        
        if (data.success) {
            // Add validation for required data
            if (!data.member) {
                console.error('API response missing member data');
                showNotification('Error: Invalid response from server', 'error');
                return;
            }
            showMemberPlans(data);
        } else {
            showNotification(data.detail || 'Failed to load nutrition plans', 'error');
        }
    } catch (error) {
        console.error('Error loading member nutrition plans:', error);
        showNotification('Error loading nutrition plans', 'error');
    }
}

// View all nutrition plans for all members
async function viewAllNutritionPlans() {
    try {
        const response = await fetch('/api/coach/nutrition/all-plans');
        const data = await response.json();
        
        if (data.success) {
            showAllNutritionPlans(data);
        } else {
            showNotification(data.detail || 'Failed to load all nutrition plans', 'error');
        }
    } catch (error) {
        console.error('Error loading all nutrition plans:', error);
        showNotification('Error loading all nutrition plans', 'error');
    }
}

// Show member details modal
function showMemberDetails(data) {
    const modal = document.getElementById('memberDetailsModal');
    const content = document.getElementById('memberDetailsContent');
    
    content.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                    <i class="fas fa-user text-xl"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900">${data.member.first_name} ${data.member.last_name}</h4>
                    <p class="text-sm text-gray-600">${data.member.email}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h5 class="text-md font-semibold text-gray-900 mb-3">Recent Nutrition Entries</h5>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${data.nutrition_entries.map(entry => `
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-gray-900">${entry.food_name}</p>
                                        <p class="text-sm text-gray-600">${entry.meal_type} • ${entry.quantity}${entry.unit}</p>
                                    </div>
                                    <div class="text-right text-sm">
                                        <p class="font-medium">${Math.round(entry.calories)} cal</p>
                                        <p class="text-gray-600">P: ${Math.round(entry.protein)}g C: ${Math.round(entry.carbs)}g F: ${Math.round(entry.fat)}g</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div>
                    <h5 class="text-md font-semibold text-gray-900 mb-3">Weekly Summary</h5>
                    <div class="space-y-2">
                        ${data.weekly_summary.map(summary => `
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">${new Date(summary.date).toLocaleDateString()}</span>
                                    <span class="text-sm text-gray-600">${summary.entries_count} entries</span>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">
                                    ${Math.round(summary.total_calories)} cal • P: ${Math.round(summary.total_protein)}g • C: ${Math.round(summary.total_carbs)}g • F: ${Math.round(summary.total_fat)}g
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Show member nutrition plans modal
function showMemberPlans(data) {
    const modal = document.getElementById('memberPlansModal');
    const content = document.getElementById('memberPlansContent');
    
    // Add error handling for missing member data
    if (!data.member) {
        console.error('Member data is missing from API response');
        showNotification('Error: Member data not found', 'error');
        return;
    }
    
    const member = data.member;
    const plans = data.plans || [];
    
    content.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center">
                    <i class="fas fa-clipboard-list text-xl"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900">${member.name}</h4>
                    <p class="text-sm text-gray-600">Nutrition Plans</p>
                </div>
            </div>
            
            ${plans.length === 0 ? `
                <div class="text-center py-8">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-clipboard-list text-gray-400 text-2xl"></i>
                    </div>
                    <h5 class="text-lg font-medium text-gray-900 mb-2">No Nutrition Plans</h5>
                    <p class="text-gray-600">This member doesn't have any nutrition plans yet.</p>
                </div>
            ` : `
                <div class="space-y-4">
                    ${plans.map(plan => `
                        <div class="border border-gray-200 rounded-lg p-6 bg-gradient-to-r from-purple-50 to-blue-50">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h5 class="text-lg font-semibold text-gray-900">${plan.plan_name}</h5>
                                    <p class="text-sm text-gray-600">Created: ${new Date(plan.created_at).toLocaleDateString()}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${
                                        plan.status === 'active' ? 'bg-green-100 text-green-800' :
                                        plan.status === 'completed' ? 'bg-blue-100 text-blue-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">
                                        ${plan.status.charAt(0).toUpperCase() + plan.status.slice(1)}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600">${plan.daily_calories}</div>
                                    <div class="text-sm text-gray-600">Daily Calories</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">${plan.daily_protein}g</div>
                                    <div class="text-sm text-gray-600">Daily Protein</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${plan.daily_carbs}g</div>
                                    <div class="text-sm text-gray-600">Daily Carbs</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-600">${plan.daily_fat}g</div>
                                    <div class="text-sm text-gray-600">Daily Fat</div>
                                </div>
                            </div>
                            
                            ${plan.notes ? `
                                <div class="mt-4 p-3 bg-white rounded-lg border border-gray-200">
                                    <h6 class="text-sm font-medium text-gray-900 mb-2">Notes:</h6>
                                    <p class="text-sm text-gray-700">${plan.notes}</p>
                                </div>
                            ` : ''}
                            
                                                                <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                                        <div class="text-sm text-gray-600">
                                            Last updated: ${new Date(plan.updated_at).toLocaleDateString()}
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="editNutritionPlan(${plan.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </button>
                                            <button onclick="deleteNutritionPlan(${plan.id})" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                                <i class="fas fa-trash mr-1"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                        </div>
                    `).join('')}
                </div>
            `}
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Show all nutrition plans modal
function showAllNutritionPlans(data) {
    const modal = document.getElementById('allPlansModal');
    const content = document.getElementById('allPlansContent');
    
    const membersPlans = data.members_plans || [];
    
    content.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center">
                    <i class="fas fa-clipboard-list text-xl"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900">All Member Nutrition Plans</h4>
                    <p class="text-sm text-gray-600">View all nutrition plans for all your members</p>
                </div>
            </div>
            
            ${membersPlans.length === 0 ? `
                <div class="text-center py-8">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-clipboard-list text-gray-400 text-2xl"></i>
                    </div>
                    <h5 class="text-lg font-medium text-gray-900 mb-2">No Nutrition Plans Found</h5>
                    <p class="text-gray-600">No nutrition plans have been created for any members yet.</p>
                </div>
            ` : `
                <div class="space-y-6">
                    ${membersPlans.map(memberData => `
                        <div class="border border-gray-200 rounded-lg p-6 bg-gradient-to-r from-purple-50 to-pink-50">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center">
                                        <i class="fas fa-user text-lg"></i>
                                    </div>
                                    <div>
                                        <h5 class="text-lg font-semibold text-gray-900">${memberData.member.name}</h5>
                                        <p class="text-sm text-gray-600">${memberData.member.email}</p>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-500">
                                    ${memberData.plans.length} plan${memberData.plans.length !== 1 ? 's' : ''}
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                ${memberData.plans.map(plan => `
                                    <div class="border border-gray-200 rounded-lg p-4 bg-white">
                                        <div class="flex items-center justify-between mb-3">
                                            <div>
                                                <h6 class="font-medium text-gray-900">${plan.plan_name}</h6>
                                                <p class="text-xs text-gray-600">Created: ${new Date(plan.created_at).toLocaleDateString()}</p>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                                    plan.status === 'active' ? 'bg-green-100 text-green-800' :
                                                    plan.status === 'completed' ? 'bg-blue-100 text-blue-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }">
                                                    ${plan.status.charAt(0).toUpperCase() + plan.status.slice(1)}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-4 gap-2 text-sm">
                                            <div class="text-center">
                                                <div class="font-bold text-purple-600">${plan.daily_calories}</div>
                                                <div class="text-xs text-gray-600">Calories</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="font-bold text-blue-600">${plan.daily_protein}g</div>
                                                <div class="text-xs text-gray-600">Protein</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="font-bold text-green-600">${plan.daily_carbs}g</div>
                                                <div class="text-xs text-gray-600">Carbs</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="font-bold text-orange-600">${plan.daily_fat}g</div>
                                                <div class="text-xs text-gray-600">Fat</div>
                                            </div>
                                        </div>
                                        
                                        ${plan.notes ? `
                                            <div class="mt-3 p-2 bg-gray-50 rounded text-xs">
                                                <span class="font-medium">Notes:</span> ${plan.notes}
                                            </div>
                                        ` : ''}
                                        
                                        <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100">
                                            <div class="text-xs text-gray-500">
                                                Updated: ${new Date(plan.updated_at).toLocaleDateString()}
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <button onclick="editNutritionPlan(${plan.id})" class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                                                    <i class="fas fa-edit mr-1"></i>Edit
                                                </button>
                                                <button onclick="deleteNutritionPlan(${plan.id})" class="text-red-600 hover:text-red-800 text-xs font-medium">
                                                    <i class="fas fa-trash mr-1"></i>Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Add nutrition feedback
function addNutritionFeedback(memberId) {
    // Implementation for adding nutrition feedback
    console.log('Add nutrition feedback for member:', memberId);
}

// Edit nutrition plan
async function editNutritionPlan(planId) {
    try {
        // Get plan details
        const response = await fetch(`/api/coach/nutrition/plan/${planId}`);
        const data = await response.json();
        
        if (data.success) {
            showEditPlanModal(data.plan);
        } else {
            showNotification(data.detail || 'Failed to load plan details', 'error');
        }
    } catch (error) {
        console.error('Error loading plan details:', error);
        showNotification('Error loading plan details', 'error');
    }
}

// Delete nutrition plan
async function deleteNutritionPlan(planId) {
    if (!confirm('Are you sure you want to delete this nutrition plan? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/coach/nutrition/plan/${planId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            showNotification('Nutrition plan deleted successfully', 'success');
            // Refresh the current view
            if (currentMemberId) {
                viewMemberPlans(currentMemberId);
            } else {
                loadAllNutritionPlans();
            }
        } else {
            showNotification(data.detail || 'Failed to delete nutrition plan', 'error');
        }
    } catch (error) {
        console.error('Error deleting nutrition plan:', error);
        showNotification('Error deleting nutrition plan', 'error');
    }
}

// Show coach comparison modal
function showCoachComparisonModal(plan, member, todayData, mealsData) {
    const modal = document.getElementById('coachComparisonModal');
    const content = document.getElementById('coachComparisonContent');
    
    // Calculate percentages and differences
    const caloriesPercent = Math.round((todayData.total_calories / plan.daily_calories) * 100);
    const proteinPercent = Math.round((todayData.total_protein / plan.daily_protein) * 100);
    const carbsPercent = Math.round((todayData.total_carbs / plan.daily_carbs) * 100);
    const fatPercent = Math.round((todayData.total_fat / plan.daily_fat) * 100);
    
    const caloriesDiff = todayData.total_calories - plan.daily_calories;
    const proteinDiff = todayData.total_protein - plan.daily_protein;
    const carbsDiff = todayData.total_carbs - plan.daily_carbs;
    const fatDiff = todayData.total_fat - plan.daily_fat;
    
    content.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900">${member.first_name} ${member.last_name}</h4>
                    <p class="text-sm text-gray-600">${plan.plan_name} vs Today's Actual Intake</p>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-purple-800">Calories</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            caloriesPercent >= 90 && caloriesPercent <= 110 ? 'bg-green-100 text-green-800' :
                            caloriesPercent < 90 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                        }">
                            ${caloriesPercent}%
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-purple-600">${Math.round(todayData.total_calories)}</div>
                    <div class="text-sm text-purple-600">/ ${plan.daily_calories} cal</div>
                    <div class="text-xs text-gray-600 mt-1">
                        ${caloriesDiff > 0 ? '+' : ''}${Math.round(caloriesDiff)} cal ${caloriesDiff > 0 ? 'over' : 'under'}
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-blue-800">Protein</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            proteinPercent >= 90 && proteinPercent <= 110 ? 'bg-green-100 text-green-800' :
                            proteinPercent < 90 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                        }">
                            ${proteinPercent}%
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-blue-600">${Math.round(todayData.total_protein)}g</div>
                    <div class="text-sm text-blue-600">/ ${plan.daily_protein}g</div>
                    <div class="text-xs text-gray-600 mt-1">
                        ${proteinDiff > 0 ? '+' : ''}${Math.round(proteinDiff)}g ${proteinDiff > 0 ? 'over' : 'under'}
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-green-800">Carbs</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            carbsPercent >= 90 && carbsPercent <= 110 ? 'bg-green-100 text-green-800' :
                            carbsPercent < 90 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                        }">
                            ${carbsPercent}%
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-green-600">${Math.round(todayData.total_carbs)}g</div>
                    <div class="text-sm text-green-600">/ ${plan.daily_carbs}g</div>
                    <div class="text-xs text-gray-600 mt-1">
                        ${carbsDiff > 0 ? '+' : ''}${Math.round(carbsDiff)}g ${carbsDiff > 0 ? 'over' : 'under'}
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-orange-800">Fat</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            fatPercent >= 90 && fatPercent <= 110 ? 'bg-green-100 text-green-800' :
                            fatPercent < 90 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                        }">
                            ${fatPercent}%
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-orange-600">${Math.round(todayData.total_fat)}g</div>
                    <div class="text-sm text-orange-600">/ ${plan.daily_fat}g</div>
                    <div class="text-xs text-gray-600 mt-1">
                        ${fatDiff > 0 ? '+' : ''}${Math.round(fatDiff)}g ${fatDiff > 0 ? 'over' : 'under'}
                    </div>
                </div>
            </div>
            
            <!-- Progress Bars -->
            <div class="space-y-4">
                <h5 class="text-lg font-semibold text-gray-900">Progress Towards Plan Goals</h5>
                
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Calories</span>
                            <span>${Math.round(todayData.total_calories)} / ${plan.daily_calories}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-500 ${
                                caloriesPercent >= 100 ? 'bg-green-500' : 
                                caloriesPercent >= 80 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${Math.min(caloriesPercent, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Protein</span>
                            <span>${Math.round(todayData.total_protein)}g / ${plan.daily_protein}g</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-500 ${
                                proteinPercent >= 100 ? 'bg-green-500' : 
                                proteinPercent >= 80 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${Math.min(proteinPercent, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Carbs</span>
                            <span>${Math.round(todayData.total_carbs)}g / ${plan.daily_carbs}g</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-500 ${
                                carbsPercent >= 100 ? 'bg-green-500' : 
                                carbsPercent >= 80 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${Math.min(carbsPercent, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Fat</span>
                            <span>${Math.round(todayData.total_fat)}g / ${plan.daily_fat}g</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-500 ${
                                fatPercent >= 100 ? 'bg-green-500' : 
                                fatPercent >= 80 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${Math.min(fatPercent, 100)}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Today's Meals Breakdown -->
            <div class="space-y-4">
                <h5 class="text-lg font-semibold text-gray-900">Today's Meals Breakdown</h5>
                
                ${mealsData.length === 0 ? `
                    <div class="text-center py-6 bg-gray-50 rounded-lg">
                        <i class="fas fa-utensils text-gray-400 text-2xl mb-2"></i>
                        <p class="text-gray-600">No meals logged today yet</p>
                        <p class="text-sm text-gray-500">Member hasn't logged any meals today</p>
                    </div>
                ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        ${mealsData.map(meal => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h6 class="font-medium text-gray-900">${meal.meal_type}</h6>
                                    <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                                        ${meal.entries_count} items
                                    </span>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Calories:</span>
                                        <span class="font-medium">${Math.round(meal.total_calories)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Protein:</span>
                                        <span class="font-medium">${Math.round(meal.total_protein)}g</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Carbs:</span>
                                        <span class="font-medium">${Math.round(meal.total_carbs)}g</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Fat:</span>
                                        <span class="font-medium">${Math.round(meal.total_fat)}g</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
            
            <!-- Coach Recommendations -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
                <h5 class="text-lg font-semibold text-blue-800 mb-3">Coach Insights</h5>
                <div class="space-y-2">
                    ${generateCoachRecommendations(plan, todayData)}
                </div>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Generate coach recommendations based on comparison
function generateCoachRecommendations(plan, todayData) {
    const recommendations = [];
    
    const caloriesPercent = (todayData.total_calories / plan.daily_calories) * 100;
    const proteinPercent = (todayData.total_protein / plan.daily_protein) * 100;
    const carbsPercent = (todayData.total_carbs / plan.daily_carbs) * 100;
    const fatPercent = (todayData.total_fat / plan.daily_fat) * 100;
    
    if (caloriesPercent < 70) {
        recommendations.push('⚠️ <strong>Significantly under calories:</strong> Consider reaching out to discuss meal planning strategies.');
    } else if (caloriesPercent > 130) {
        recommendations.push('⚠️ <strong>Significantly over calories:</strong> May need guidance on portion control and meal timing.');
    }
    
    if (proteinPercent < 70) {
        recommendations.push('🥩 <strong>Low protein intake:</strong> Suggest protein-rich snacks or meal additions.');
    }
    
    if (carbsPercent < 70) {
        recommendations.push('🍞 <strong>Low carb intake:</strong> Recommend whole grain options and fruits.');
    } else if (carbsPercent > 130) {
        recommendations.push('🌾 <strong>High carb intake:</strong> Consider suggesting protein/fat alternatives.');
    }
    
    if (fatPercent < 70) {
        recommendations.push('🥑 <strong>Low fat intake:</strong> Suggest healthy fat sources like nuts and avocados.');
    } else if (fatPercent > 130) {
        recommendations.push('💧 <strong>High fat intake:</strong> Recommend leaner protein sources.');
    }
    
    if (recommendations.length === 0) {
        recommendations.push('✅ <strong>Great progress!</strong> Member is following the nutrition plan well.');
    }
    
    return recommendations.map(rec => `<p class="text-sm text-blue-700">${rec}</p>`).join('');
}

// Show edit nutrition plan modal
function showEditPlanModal(plan) {
    const modal = document.getElementById('editPlanModal');
    
    // Populate form with current plan data
    document.getElementById('editPlanId').value = plan.id;
    document.getElementById('editPlanName').value = plan.plan_name;
    document.getElementById('editDailyCalories').value = plan.daily_calories;
    document.getElementById('editDailyProtein').value = plan.daily_protein;
    document.getElementById('editDailyCarbs').value = plan.daily_carbs;
    document.getElementById('editDailyFat').value = plan.daily_fat;
    document.getElementById('editPlanNotes').value = plan.notes || '';
    
    modal.classList.remove('hidden');
}

// Handle edit plan form submission
document.addEventListener('DOMContentLoaded', function() {
    const editPlanForm = document.getElementById('editPlanForm');
    if (editPlanForm) {
        editPlanForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const planId = document.getElementById('editPlanId').value;
            const planData = {
                plan_name: document.getElementById('editPlanName').value,
                daily_calories: parseInt(document.getElementById('editDailyCalories').value),
                daily_protein: parseInt(document.getElementById('editDailyProtein').value),
                daily_carbs: parseInt(document.getElementById('editDailyCarbs').value),
                daily_fat: parseInt(document.getElementById('editDailyFat').value),
                notes: document.getElementById('editPlanNotes').value
            };
            
            try {
                const response = await fetch(`/api/coach/nutrition/plan/${planId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Nutrition plan updated successfully', 'success');
                    closeModal('editPlanModal');
                    
                    // Refresh the current view
                    if (currentMemberId) {
                        viewMemberPlans(currentMemberId);
                    } else {
                        loadAllNutritionPlans();
                    }
                } else {
                    showNotification(data.detail || 'Failed to update nutrition plan', 'error');
                }
            } catch (error) {
                console.error('Error updating nutrition plan:', error);
                showNotification('Error updating nutrition plan', 'error');
            }
        });
    }
});

// Delete nutrition plan
async function deleteNutritionPlan(planId) {
    if (!confirm('Are you sure you want to delete this nutrition plan?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/coach/nutrition/plan/${planId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Nutrition plan deleted successfully!', 'success');
            // Refresh the plans modal
            const currentMemberId = getCurrentMemberId();
            if (currentMemberId) {
                viewMemberPlans(currentMemberId);
            }
        } else {
            showNotification(data.detail || 'Failed to delete plan', 'error');
        }
    } catch (error) {
        console.error('Error deleting nutrition plan:', error);
        showNotification('Error deleting nutrition plan', 'error');
    }
}

// Helper function to get current member ID (you might need to store this when opening the modal)
let currentMemberId = null;

function getCurrentMemberId() {
    return currentMemberId;
}

// Modal functions
function openCreatePlanModal() {
    document.getElementById('createPlanModal').classList.remove('hidden');
    loadMembersForPlan();
    resetMemberSelection();
}

// Reset member selection when modal opens
function resetMemberSelection() {
    document.getElementById('selectedMemberId').value = '';
    document.getElementById('selectedMemberDisplay').classList.add('hidden');
    document.getElementById('memberSelectionCards').classList.remove('hidden');
    document.getElementById('memberSearch').classList.remove('hidden');
    document.getElementById('memberSearch').value = '';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

// Store all members for selection
let allMembers = [];

// Load members for plan creation
async function loadMembersForPlan() {
    const container = document.getElementById('memberSelectionCards');
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center py-8">
            <div class="w-8 h-8 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Loading members...</p>
        </div>
    `;
    
    try {
        const response = await fetch('/api/coach/nutrition/members');
        const data = await response.json();
        
        if (data.success) {
            allMembers = data.members;
            renderMemberCards(allMembers);
            setupMemberSearch();
        } else {
            container.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Failed to load members</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading members for plan:', error);
        container.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>Error loading members</p>
            </div>
        `;
    }
}

// Render member selection cards
function renderMemberCards(members) {
    const container = document.getElementById('memberSelectionCards');
    
    if (members.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-users text-gray-400 text-2xl"></i>
                </div>
                <h5 class="text-lg font-medium text-gray-900 mb-2">No Members Found</h5>
                <p class="text-gray-600">No members match your search criteria.</p>
                <button onclick="renderMemberCards(allMembers)" class="mt-3 text-emerald-600 hover:text-emerald-800 text-sm font-medium">
                    <i class="fas fa-refresh mr-1"></i>Show All Members
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = members.map(member => `
        <div class="member-card cursor-pointer p-4 border border-gray-200 rounded-lg hover:border-emerald-300 hover:bg-emerald-50 transition-all duration-200 hover:shadow-md" 
             data-member-id="${member.id}" 
             onclick="selectMember(${member.id}, '${member.name}', '${member.email}')">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-r from-emerald-400 to-teal-500 text-white flex items-center justify-center shadow-sm">
                    <span class="font-medium text-sm">${member.name.charAt(0)}</span>
                </div>
                <div class="flex-1">
                    <h4 class="font-medium text-gray-900">${member.name}</h4>
                    <p class="text-sm text-gray-600">${member.email}</p>
                    <div class="flex items-center space-x-2 mt-1">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fas fa-user mr-1"></i>Member
                        </span>
                    </div>
                </div>
                <div class="text-emerald-500 opacity-0 transition-opacity duration-200">
                    <i class="fas fa-check text-lg"></i>
                </div>
            </div>
        </div>
    `).join('');
}

// Setup member search functionality
function setupMemberSearch() {
    const searchInput = document.getElementById('memberSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredMembers = allMembers.filter(member => {
                const name = member.name.toLowerCase();
                const email = member.email.toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm);
            });
            renderMemberCards(filteredMembers);
        });
    }
}

// Select a member
function selectMember(memberId, name, email) {
    // Update hidden input
    document.getElementById('selectedMemberId').value = memberId;
    
    // Update selected member display
    document.getElementById('selectedMemberName').textContent = name;
    document.getElementById('selectedMemberEmail').textContent = email;
    document.getElementById('selectedMemberDisplay').classList.remove('hidden');
    
    // Update card styling
    document.querySelectorAll('.member-card').forEach(card => {
        card.classList.remove('border-emerald-500', 'bg-emerald-100');
        card.querySelector('.text-emerald-500').classList.add('opacity-0');
    });
    
    const selectedCard = document.querySelector(`[data-member-id="${memberId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('border-emerald-500', 'bg-emerald-100');
        selectedCard.querySelector('.text-emerald-500').classList.remove('opacity-0');
    }
    
    // Hide member cards after selection
    document.getElementById('memberSelectionCards').classList.add('hidden');
    document.getElementById('memberSearch').classList.add('hidden');
}

// Clear member selection
function clearMemberSelection() {
    document.getElementById('selectedMemberId').value = '';
    document.getElementById('selectedMemberDisplay').classList.add('hidden');
    document.getElementById('memberSelectionCards').classList.remove('hidden');
    document.getElementById('memberSearch').classList.remove('hidden');
    document.getElementById('memberSearch').value = '';
    
    // Reset card styling
    document.querySelectorAll('.member-card').forEach(card => {
        card.classList.remove('border-emerald-500', 'bg-emerald-100');
        card.querySelector('.text-emerald-500').classList.add('opacity-0');
    });
    
    renderMemberCards(allMembers);
}

// Change member selection (show cards again)
function changeMemberSelection() {
    document.getElementById('selectedMemberDisplay').classList.add('hidden');
    document.getElementById('memberSelectionCards').classList.remove('hidden');
    document.getElementById('memberSearch').classList.remove('hidden');
    document.getElementById('memberSearch').focus();
    
    // Reset card styling
    document.querySelectorAll('.member-card').forEach(card => {
        card.classList.remove('border-emerald-500', 'bg-emerald-100');
        card.querySelector('.text-emerald-500').classList.add('opacity-0');
    });
}

// Handle plan creation form
document.getElementById('createPlanForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    
    try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
        
        const response = await fetch('/api/coach/nutrition/plan', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Nutrition plan created successfully!', 'success');
            closeModal('createPlanModal');
            this.reset();
        } else {
            showNotification(data.detail || 'Failed to create plan', 'error');
        }
    } catch (error) {
        console.error('Error creating nutrition plan:', error);
        showNotification('Error creating nutrition plan', 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Create Plan';
    }
});

// Utility functions
function getMealIcon(mealType) {
    const icons = {
        'Breakfast': 'fa-coffee',
        'Lunch': 'fa-hamburger',
        'Dinner': 'fa-utensils',
        'Snack': 'fa-cookie-bite'
    };
    return icons[mealType] || 'fa-utensils';
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.remove('translate-x-full'), 100);
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
}

// Event listeners
document.getElementById('timeRangeFilter').addEventListener('change', function() {
    console.log('Time range changed to:', this.value);
    
    // Destroy existing chart before loading new data
    if (mealTypeChart) {
        mealTypeChart.destroy();
        mealTypeChart = null;
    }
    
    loadAnalytics();
});

// Handle window resize to ensure chart stays properly sized
window.addEventListener('resize', function() {
    if (mealTypeChart) {
        mealTypeChart.resize();
    }
    if (macroNutrientChart) {
        macroNutrientChart.resize();
    }
});

// Export nutrition function
async function exportNutrition(format) {
    try {
        const url = `/api/export/nutrition/coach?format=${format}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error('Failed to export nutrition data');
        }
        
        // Create a temporary link to download the file
        const blob = await response.blob();
        const url2 = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url2;
        a.download = `coach_nutrition_${new Date().toISOString().split('T')[0]}.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url2);
        document.body.removeChild(a);
        
    } catch (error) {
        console.error('Error exporting nutrition data:', error);
        alert('Failed to export nutrition data. Please try again.');
    }
}

// Refresh nutrition data
async function refreshNutritionData() {
    const refreshBtn = document.querySelector('button[onclick="refreshNutritionData()"]');
    const originalText = refreshBtn.innerHTML;
    
    try {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
        
        await Promise.all([
            loadNutritionDashboard(),
            loadAnalytics()
        ]);
        
        showNotification('Nutrition data refreshed successfully', 'success');
    } catch (error) {
        console.error('Error refreshing nutrition data:', error);
        showNotification('Error refreshing nutrition data', 'error');
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalText;
    }
}

// Load coach sidebar stats
async function loadCoachSidebarStats() {
    try {
        const response = await fetch('/api/coach/dashboard');
        const data = await response.json();
        
        const sidebarActiveMembers = document.getElementById('activeMembers');
        const sidebarWeekSessions = document.getElementById('weekSessions');
        const sidebarProgressBar = document.getElementById('progressBar');
        
        if (sidebarActiveMembers) sidebarActiveMembers.textContent = data.stats.active_members || 0;
        if (sidebarWeekSessions) sidebarWeekSessions.textContent = `${data.stats.week_sessions || 0} sessions`;
        if (sidebarProgressBar) sidebarProgressBar.style.width = `${data.stats.performance_rating || 85}%`;
    } catch (error) {
        console.error('Error loading coach sidebar stats:', error);
    }
}
</script>
{% endblock %} 