{% extends "base.html" %}

{% block title %}Sessions - PowerFit{% endblock %}

{% block content %}
    <!-- Sessions Overview -->
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Sessions</h3>
                    <p class="mt-1 text-sm text-gray-500">Manage your gym's training sessions</p>
                </div>
                <button onclick="openAddSessionModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    <i class="fas fa-plus mr-2"></i> Add Session
                </button>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="member" class="block text-sm font-medium text-gray-700">Member</label>
                    <select id="member" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">All Members</option>
                    </select>
                </div>
                <div>
                    <label for="coach" class="block text-sm font-medium text-gray-700">Coach</label>
                    <select id="coach" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">All Coaches</option>
                    </select>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">All Status</option>
                        <option value="Scheduled">Scheduled</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Sessions List -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div id="sessionsList" class="space-y-4">
                <!-- Sessions will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add Session Modal -->
    <div id="addSessionModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Session</h3>
                    <form id="addSessionForm" class="space-y-4">
                        <div>
                            <label for="session_member" class="block text-sm font-medium text-gray-700">Member</label>
                            <select id="session_member" name="member_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">Select Member</option>
                            </select>
                        </div>
                        <div>
                            <label for="session_coach" class="block text-sm font-medium text-gray-700">Coach</label>
                            <select id="session_coach" name="coach_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">Select Coach</option>
                            </select>
                        </div>
                        <div>
                            <label for="session_date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="session_date" name="session_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="session_time" class="block text-sm font-medium text-gray-700">Time</label>
                            <input type="time" id="session_time" name="session_time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="session_type" class="block text-sm font-medium text-gray-700">Session Type</label>
                            <select id="session_type" name="session_type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">Select Type</option>
                                <option value="Personal Training">Personal Training</option>
                                <option value="Group Class">Group Class</option>
                                <option value="Consultation">Consultation</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeAddSessionModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
                                Cancel
                            </button>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                                Add Session
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Load sessions data
    async function loadSessions() {
        try {
            const date = document.getElementById('date').value;
            const member = document.getElementById('member').value;
            const coach = document.getElementById('coach').value;
            const status = document.getElementById('status').value;
            
            const response = await fetch(`/api/gym/sessions?date=${date}&member=${member}&coach=${coach}&status=${status}`);
            const sessions = await response.json();
            
            const sessionsListDiv = document.getElementById('sessionsList');
            if (sessions.length === 0) {
                sessionsListDiv.innerHTML = '<p class="text-gray-500">No sessions found.</p>';
            } else {
                sessionsListDiv.innerHTML = sessions.map(session => `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                            <h4 class="font-medium text-gray-900">${session.member_name}</h4>
                            <p class="text-sm text-gray-500">with ${session.coach_name}</p>
                            <p class="text-xs text-gray-400">${session.session_type} â€¢ ${new Date(session.session_date).toLocaleDateString()} at ${session.session_time}</p>
                        </div>
                        <div class="text-right">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${session.status === 'Completed' ? 'bg-green-100 text-green-800' : 
                                  session.status === 'Cancelled' ? 'bg-red-100 text-red-800' : 
                                  'bg-blue-100 text-blue-800'}">
                                ${session.status}
                            </span>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading sessions:', error);
        }
    }

    // Load members and coaches for dropdowns
    async function loadDropdowns() {
        try {
            // Load members
            const membersResponse = await fetch('/api/gym/members');
            const members = await membersResponse.json();
            const memberSelect = document.getElementById('member');
            const sessionMemberSelect = document.getElementById('session_member');
            
            members.forEach(member => {
                const option = new Option(member.name, member.id);
                memberSelect.add(option);
                sessionMemberSelect.add(new Option(member.name, member.id));
            });

            // Load coaches
            const coachesResponse = await fetch('/api/gym/coaches');
            const coaches = await coachesResponse.json();
            const coachSelect = document.getElementById('coach');
            const sessionCoachSelect = document.getElementById('session_coach');
            
            coaches.forEach(coach => {
                const option = new Option(coach.name, coach.id);
                coachSelect.add(option);
                sessionCoachSelect.add(new Option(coach.name, coach.id));
            });
        } catch (error) {
            console.error('Error loading dropdowns:', error);
        }
    }

    // Modal functions
    function openAddSessionModal() {
        document.getElementById('addSessionModal').classList.remove('hidden');
    }

    function closeAddSessionModal() {
        document.getElementById('addSessionModal').classList.add('hidden');
    }

    // Add session form submission
    document.getElementById('addSessionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            member_id: document.getElementById('session_member').value,
            coach_id: document.getElementById('session_coach').value,
            session_date: document.getElementById('session_date').value,
            session_time: document.getElementById('session_time').value,
            session_type: document.getElementById('session_type').value
        };
        
        try {
            const response = await fetch('/api/gym/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                closeAddSessionModal();
                loadSessions();
            } else {
                const error = await response.json();
                alert(error.detail || 'Error adding session');
            }
        } catch (error) {
            console.error('Error adding session:', error);
            alert('Error adding session');
        }
    });

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadDropdowns();
        loadSessions();
    });

    // Add event listeners for search and filters
    document.getElementById('date').addEventListener('change', loadSessions);
    document.getElementById('member').addEventListener('change', loadSessions);
    document.getElementById('coach').addEventListener('change', loadSessions);
    document.getElementById('status').addEventListener('change', loadSessions);
</script>
{% endblock %}

{% block sidebar %}
<a href="/gym/dashboard" class="block py-2 px-4 hover:bg-indigo-700">
    <i class="fas fa-home mr-2"></i> Dashboard
</a>
<a href="/gym/members" class="block py-2 px-4 hover:bg-indigo-700">
    <i class="fas fa-users mr-2"></i> Members
</a>
<a href="/gym/coaches" class="block py-2 px-4 hover:bg-indigo-700">
    <i class="fas fa-user-tie mr-2"></i> Coaches
</a>
<a href="/gym/sessions" class="block py-2 px-4 bg-indigo-700">
    <i class="fas fa-calendar mr-2"></i> Sessions
</a>
{% endblock %} 