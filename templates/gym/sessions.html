{% extends "base.html" %}

{% block title %}Sessions - PowerFit{% endblock %}

{% block content %}
 <!-- Welcome Section -->
 <div class="bg-white shadow rounded-lg mb-4 sm:mb-6">
 <div class="px-4 py-5 sm:p-4 sm:p-6">
 <div class="flex justify-between items-center">
 <div>
 <h3 class="text-lg leading-6 font-medium text-gray-900">All Sessions</h3>
 <p class="mt-1 text-sm text-gray-500">View and manage all training sessions</p>
 </div>
 <div class="flex items-center space-x-2">
 <button onclick="exportGymSessions('xlsx')" 
 class="bg-blue-600 text-white px-3 py-2 sm:px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:outline-none
 <i class="fas fa-file-excel mr-2"></i>Export Excel
 </button>
 </div>
 </div>
 </div>
 </div>

 <!-- Weekly Schedule -->
 <div class="bg-white shadow rounded-lg p-4 sm:p-6 mb-4 sm:mb-6">
 <div class="flex justify-between items-center mb-4 sm:mb-6">
 <h2 class="text-lg font-medium text-gray-900">Weekly Schedule</h2>
 <div class="flex items-center space-x-2 sm:space-x-4">
 <div class="flex items-center space-x-2">
 <input type="date" 
 id="startDate" 
 class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:outline-none focus:border-indigo-500">
 <span class="text-gray-500">to</span>
 <input type="date" 
 id="endDate" 
 class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:outline-none focus:border-indigo-500">
 <button onclick="loadSchedule()" 
 class="bg-indigo-600 text-white px-3 py-2 sm:px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:outline-none
 <i class="fas fa-search mr-2"></i>Search
 </button>
 </div>
 </div>
 </div>
 <div class="grid grid-cols-7 gap-4" id="weeklySchedule">
 <!-- Days will be populated here -->
 </div>
 </div>

 <!-- Filters -->
 <div class="bg-white shadow rounded-lg mb-4 sm:mb-6">
 <div class="px-4 py-5 sm:p-4 sm:p-6">
 <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-4">
 <!-- Search Bar -->
 <div class="sm:col-span-2">
 <label for="searchFilter" class="block text-sm font-medium text-gray-700">Search Member/Coach</label>
 <div class="mt-1 relative">
 <input type="text" 
 id="searchFilter" 
 placeholder="Type member or coach name..."
 class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:border-indigo-500 sm:text-sm rounded-md">
 <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
 <i class="fas fa-search text-gray-400"></i>
 </div>
 </div>
 </div>

 <!-- Date Range -->
 <div>
 <label for="dateRange" class="block text-sm font-medium text-gray-700">Date Range</label>
 <select id="dateRange" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:border-indigo-500 sm:text-sm rounded-md">
 <option value="all">All Time</option>
 <option value="today">Today</option>
 <option value="week">This Week</option>
 <option value="month">This Month</option>
 </select>
 </div>

 <!-- Status -->
 <div>
 <label for="statusFilter" class="block text-sm font-medium text-gray-700">Status</label>
 <select id="statusFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:border-indigo-500 sm:text-sm rounded-md">
 <option value="all">All Status</option>
 <option value="scheduled">Scheduled</option>
 <option value="completed">Completed</option>
 <option value="cancelled">Cancelled</option>
 </select>
 </div>

 <!-- Clear Filters -->
 <div class="flex items-end">
 <button onclick="clearFilters()" 
 class="w-full bg-gray-500 text-white px-3 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:outline-none transition-colors">
 <i class="fas fa-times mr-2"></i>Clear Filters
 </button>
 </div>
 </div>
 </div>
 </div>

 <!-- Sessions List -->
 <div class="bg-white shadow rounded-lg">
 <div class="px-4 py-5 sm:p-4 sm:p-6">
 <div class="overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
 <table class="min-w-full responsive-table divide-y divide-gray-200">
 <thead>
 <tr>
 <th class="px-3 py-2 sm:px-4 sm:px-6 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member</th>
 <th class="px-3 py-2 sm:px-4 sm:px-6 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coach</th>
 <th class="px-3 py-2 sm:px-4 sm:px-6 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
 <th class="px-3 py-2 sm:px-4 sm:px-6 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
 <th class="px-3 py-2 sm:px-4 sm:px-6 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Workout</th>
 <th class="px-3 py-2 sm:px-4 sm:px-6 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
 <th class="px-3 py-2 sm:px-4 sm:px-6 sm:py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
 </tr>
 </thead>
 <tbody class="bg-white divide-y divide-gray-200" id="sessions-table">
 <!-- Sessions will be populated here -->
 </tbody>
 </table>
 </div>
 </div>
 </div>

 <!-- Session Details Modal -->
 <div id="sessionModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden">
 <div class="flex items-center justify-center min-h-screen p-4">
 <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
 <div class="px-4 py-5 sm:p-4 sm:p-6">
 <div class="flex justify-between items-start">
 <h3 class="text-lg font-medium text-gray-900">Session Details</h3>
 <button onclick="closeSessionModal()" class="text-gray-400 hover:text-gray-500">
 <i class="fas fa-times"></i>
 </button>
 </div>
 <div class="mt-4 space-y-4">
 <div>
 <p class="text-sm text-gray-500">Member</p>
 <p class="text-base font-medium text-gray-900" id="modalMemberName">-</p>
 <p class="text-sm text-gray-500" id="modalMemberEmail">-</p>
 </div>
 <div>
 <p class="text-sm text-gray-500">Coach</p>
 <p class="text-base font-medium text-gray-900" id="modalCoachName">-</p>
 <p class="text-sm text-gray-500" id="modalCoachSpecialization">-</p>
 </div>
 <div>
 <p class="text-sm text-gray-500">Date & Time</p>
 <p class="text-base font-medium text-gray-900" id="modalDateTime">-</p>
 </div>
 <div>
 <p class="text-sm text-gray-500">Duration</p>
 <p class="text-base font-medium text-gray-900" id="modalDuration">-</p>
 </div>
 <div>
 <p class="text-sm text-gray-500">Workout Type</p>
 <p class="text-base font-medium text-gray-900" id="modalWorkoutType">-</p>
 </div>
 <div>
 <p class="text-sm text-gray-500">Exercises</p>
 <ul class="text-sm text-gray-900 list-disc list-inside" id="modalExercises">
 <!-- Exercises will be populated here -->
 </ul>
 </div>
 <div>
 <p class="text-sm text-gray-500">Status</p>
 <p class="text-base font-medium text-gray-900" id="modalStatus">-</p>
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>
{% endblock %}

{% block scripts %}
<script>
 // Store sessions globally
 let sessions = [];

 // Format date as YYYY-MM-DD
 function formatDate(date) {
 return date.toISOString().split('T')[0];
 }

 // Get week range
 function getWeekRange(date) {
 const start = new Date(date);
 start.setDate(date.getDate() - date.getDay());
 const end = new Date(start);
 end.setDate(start.getDate() + 6);
 return { start, end };
 }

 // Set default date range (current week)
 function setDefaultDateRange() {
 const today = new Date();
 const startDate = new Date(today);
 startDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
 
 const endDate = new Date(today);
 endDate.setDate(today.getDate() + (6 - today.getDay())); // End of week (Saturday)
 
 document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
 document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
 }

 // Load schedule with date range
 async function loadSchedule() {
 const startDate = document.getElementById('startDate').value;
 const endDate = document.getElementById('endDate').value;
 
 if (!startDate || !endDate) {
 alert('Please select both start and end dates');
 return;
 }
 
 try {
 const response = await fetch(`/api/gym/sessions?start_date=${startDate}&end_date=${endDate}`);
 if (!response.ok) {
 throw new Error('Failed to fetch schedule');
 }
 const sessions = await response.json();
 displaySchedule(sessions);
 } catch (error) {
 console.error('Error:', error);
 alert('Failed to load schedule');
 }
 }

 // Display schedule
 function displaySchedule(sessions) {
 const scheduleContainer = document.getElementById('weeklySchedule');
 const startDate = new Date(document.getElementById('startDate').value);
 const endDate = new Date(document.getElementById('endDate').value);
 
 // Clear existing schedule
 scheduleContainer.innerHTML = '';
 
 // Create day columns
 const currentDate = new Date(startDate);
 while (currentDate <= endDate) {
 const daySessions = sessions.filter(session => 
 session.date === currentDate.toISOString().split('T')[0]
 );
 
 const dayColumn = document.createElement('div');
 dayColumn.className = 'space-y-2';
 
 // Day header
 const dayHeader = document.createElement('div');
 dayHeader.className = 'text-center font-medium text-gray-900 mb-2';
 dayHeader.textContent = currentDate.toLocaleDateString('en-US', { 
 weekday: 'short', 
 month: 'short', 
 day: 'numeric' 
 });
 dayColumn.appendChild(dayHeader);
 
 // Sessions for this day
 if (daySessions.length === 0) {
 const noSessions = document.createElement('div');
 noSessions.className = 'text-center text-gray-500 text-sm';
 noSessions.textContent = 'No sessions';
 dayColumn.appendChild(noSessions);
 } else {
 daySessions.forEach(session => {
 const sessionCard = document.createElement('div');
 sessionCard.className = 'bg-gray-50 rounded-lg p-3 cursor-pointer hover:bg-gray-100';
 sessionCard.onclick = () => viewSessionDetails(session.id);
 
 sessionCard.innerHTML = `
 <div class="text-sm font-medium text-gray-900">${session.time || 'No time'}</div>
 <div class="text-xs text-gray-500">${session.member.name || 'Unknown Member'}</div>
 <div class="text-xs text-gray-500">${session.coach.name || 'Unknown Coach'}</div>
 <div class="mt-1">
 <span class="px-2 py-1 text-xs rounded-full ${
 session.status.toLowerCase() === 'completed' ? 'bg-green-100 text-green-800' :
 session.status.toLowerCase() === 'cancelled' ? 'bg-red-100 text-red-800' :
 'bg-blue-100 text-blue-800'
 }">${session.status.charAt(0).toUpperCase() + session.status.slice(1)}</span>
 </div>
 `;
 
 dayColumn.appendChild(sessionCard);
 });
 }
 
 scheduleContainer.appendChild(dayColumn);
 currentDate.setDate(currentDate.getDate() + 1);
 }
 }

 // Store all sessions globally
 let allSessions = [];
 let filteredSessions = [];

 // Load sessions data
 async function loadSessionsData() {
 try {
 const response = await fetch('/api/gym/sessions');
 allSessions = await response.json();
 filteredSessions = [...allSessions];
 applyFilters();
 } catch (error) {
 console.error('Error loading sessions data:', error);
 }
 }

 // Apply filters to sessions
 function applyFilters() {
 const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
 const dateRange = document.getElementById('dateRange').value;
 const statusFilter = document.getElementById('statusFilter').value;

 // Filter by search term (member or coach name)
 let filtered = allSessions.filter(session => {
 const memberName = session.member.name.toLowerCase();
 const coachName = session.coach.name.toLowerCase();
 return memberName.includes(searchTerm) || coachName.includes(searchTerm);
 });

 // Filter by date range
 if (dateRange !== 'all') {
 const today = new Date();
 const todayStr = today.toISOString().split('T')[0];
 
 filtered = filtered.filter(session => {
 const sessionDate = new Date(session.date);
 
 switch (dateRange) {
 case 'today':
 return session.date === todayStr;
 case 'week':
 const weekAgo = new Date(today);
 weekAgo.setDate(today.getDate() - 7);
 return sessionDate >= weekAgo && sessionDate <= today;
 case 'month':
 const monthAgo = new Date(today);
 monthAgo.setMonth(today.getMonth() - 1);
 return sessionDate >= monthAgo && sessionDate <= today;
 default:
 return true;
 }
 });
 }

 // Filter by status
 if (statusFilter !== 'all') {
 filtered = filtered.filter(session => 
 session.status.toLowerCase() === statusFilter.toLowerCase()
 );
 }

 filteredSessions = filtered;
 displaySessions(filteredSessions);
 }

 // Display sessions in table
 function displaySessions(sessions) {
 const sessionsTable = document.getElementById('sessions-table');
 sessionsTable.innerHTML = '';
 
 if (sessions.length === 0) {
 sessionsTable.innerHTML = `
 <tr>
 <td colspan="7" class="px-6 py-4 text-center text-gray-500">
 <i class="fas fa-search text-2xl mb-2"></i>
 <p>No sessions found matching your filters</p>
 </td>
 </tr>
 `;
 return;
 }
 
 sessions.forEach(session => {
 const row = document.createElement('tr');
 row.innerHTML = `
 <td class="px-6 py-4 whitespace-nowrap">
 <div class="text-sm font-medium text-gray-900">${session.member.name || 'Unknown Member'}</div>
 <div class="text-sm text-gray-500">${session.member.email || 'No email'}</div>
 </td>
 <td class="px-6 py-4 whitespace-nowrap">
 <div class="text-sm font-medium text-gray-900">${session.coach.name || 'Unknown Coach'}</div>
 <div class="text-sm text-gray-500">${session.coach.specialization || 'No specialization'}</div>
 </td>
 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${session.date}</td>
 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${session.time}</td>
 <td class="px-6 py-4 whitespace-nowrap">
 <div class="text-sm text-gray-900">${session.workout.type || 'General Training'}</div>
 <div class="text-sm text-gray-500">${session.workout.exercises ? session.workout.exercises.length : 0} exercises</div>
 </td>
 <td class="px-6 py-4 whitespace-nowrap">
 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
 ${session.status.toLowerCase() === 'completed' ? 'bg-green-100 text-green-800' : 
 session.status.toLowerCase() === 'cancelled' ? 'bg-red-100 text-red-800' : 
 'bg-blue-100 text-blue-800'}">
 ${session.status.charAt(0).toUpperCase() + session.status.slice(1)}
 </span>
 </td>
 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
 <button onclick="viewSessionDetails(${session.id})" 
 class="text-indigo-600 hover:text-indigo-900">
 <i class="fas fa-eye"></i>
 </button>
 </td>
 `;
 sessionsTable.appendChild(row);
 });
 }



 // View session details
 function viewSessionDetails(sessionId) {
 const session = filteredSessions.find(s => s.id === sessionId);
 if (!session) {
 console.error('Session not found');
 return;
 }

 const modal = document.getElementById('sessionModal');
 document.getElementById('modalMemberName').textContent = session.member.name || 'Unknown Member';
 document.getElementById('modalMemberEmail').textContent = session.member.email || 'No email';
 document.getElementById('modalCoachName').textContent = session.coach.name || 'Unknown Coach';
 document.getElementById('modalCoachSpecialization').textContent = session.coach.specialization || 'No specialization';
 document.getElementById('modalDateTime').textContent = `${session.date} at ${session.time}`;
 document.getElementById('modalDuration').textContent = `${session.duration} minutes`;
 document.getElementById('modalWorkoutType').textContent = session.workout.type || 'General Training';
 document.getElementById('modalStatus').textContent = session.status.charAt(0).toUpperCase() + session.status.slice(1);

 // Populate exercises
 const exercisesList = document.getElementById('modalExercises');
 exercisesList.innerHTML = '';
 if (session.workout.exercises && session.workout.exercises.length > 0) {
 session.workout.exercises.forEach(exercise => {
 const li = document.createElement('li');
 li.textContent = exercise;
 exercisesList.appendChild(li);
 });
 } else {
 const li = document.createElement('li');
 li.textContent = 'No exercises specified';
 exercisesList.appendChild(li);
 }

 modal.classList.remove('hidden');
 }

 function closeSessionModal() {
 document.getElementById('sessionModal').classList.add('hidden');
 }

 // Clear filters function
 function clearFilters() {
 document.getElementById('searchFilter').value = '';
 document.getElementById('dateRange').value = 'all';
 document.getElementById('statusFilter').value = 'all';
 applyFilters();
 }

 // Add event listeners for filters
 document.getElementById('searchFilter').addEventListener('input', () => {
 applyFilters();
 });

 document.getElementById('dateRange').addEventListener('change', () => {
 applyFilters();
 });

 document.getElementById('statusFilter').addEventListener('change', () => {
 applyFilters();
 });

 // Load gym sidebar stats
 async function loadGymSidebarStats() {
 try {
 const response = await fetch('/api/gym/dashboard');
 const data = await response.json();
 
 const sidebarTotalMembers = document.getElementById('sidebarTotalMembers');
 const sidebarActiveCoaches = document.getElementById('sidebarActiveCoaches');
 const sidebarTodaySessions = document.getElementById('sidebarTodaySessions');
 
 if (sidebarTotalMembers) sidebarTotalMembers.textContent = data.stats.total_members || 0;
 if (sidebarActiveCoaches) sidebarActiveCoaches.textContent = data.stats.active_coaches || 0;
 if (sidebarTodaySessions) sidebarTodaySessions.textContent = data.stats.today_sessions || 0;
 } catch (error) {
 console.error('Error loading gym sidebar stats:', error);
 }
 }

 // Initialize page
 document.addEventListener('DOMContentLoaded', () => {
 setDefaultDateRange();
 loadSessionsData();
 loadSchedule();
 loadGymSidebarStats();
 });

 // Export gym sessions function
 async function exportGymSessions(format) {
 try {
 const url = `/api/export/sessions/gym?format=${format}`;
 const response = await fetch(url);
 
 if (!response.ok) {
 throw new Error('Failed to export sessions');
 }
 
 // Create a temporary link to download the file
 const blob = await response.blob();
 const url2 = window.URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url2;
 a.download = `gym_sessions_${new Date().toISOString().split('T')[0]}.${format}`;
 document.body.appendChild(a);
 a.click();
 window.URL.revokeObjectURL(url2);
 document.body.removeChild(a);
 
 } catch (error) {
 console.error('Error exporting sessions:', error);
 alert('Failed to export sessions. Please try again.');
 }
 }
</script>
{% endblock %} 