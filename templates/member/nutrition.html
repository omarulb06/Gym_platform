{% extends "base.html" %}

{% block head %}
<!-- Hugging Face Transformers.js for superior food recognition -->
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.0/dist/transformers.min.js"></script>
<!-- Chart.js for weekly progress charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Custom Chart Implementation - No external dependencies -->
<script>
// Custom chart implementation using pure HTML/CSS/JavaScript
class CustomChart {
    constructor(container, data, options = {}) {
        this.container = container;
        this.data = data;
        this.options = {
            type: 'line',
            height: 300,
            colors: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
            ...options
        };
        this.render();
    }
    
    render() {
        if (this.options.type === 'line') {
            this.renderLineChart();
        } else if (this.options.type === 'bar') {
            this.renderBarChart();
        }
    }
    
    renderLineChart() {
        const { labels, datasets } = this.data;
        const maxValue = Math.max(...datasets.flatMap(dataset => dataset.data));
        const minValue = Math.min(...datasets.flatMap(dataset => dataset.data));
        const range = maxValue - minValue;
        
        const chartHTML = `
            <div class="custom-chart-container" style="height: ${this.options.height}px; position: relative;">
                <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                    ${this.renderGrid(range, minValue)}
                    ${datasets.map((dataset, index) => this.renderLine(dataset, labels, range, minValue, index)).join('')}
                    ${this.renderPoints(datasets, labels, range, minValue)}
                </svg>
                <div class="chart-labels flex justify-between text-xs text-gray-500 mt-2">
                    ${labels.map(label => `<span>${label}</span>`).join('')}
                </div>
            </div>
        `;
        
        this.container.innerHTML = chartHTML;
    }
    
    renderGrid(range, minValue) {
        const gridLines = [];
        const steps = 5;
        
        for (let i = 0; i <= steps; i++) {
            const y = 100 - (i * 100 / steps);
            const value = minValue + (range * i / steps);
            gridLines.push(`
                <line x1="0" y1="${y}" x2="100" y2="${y}" stroke="#e5e7eb" stroke-width="0.5" opacity="0.5"/>
                <text x="0" y="${y + 2}" font-size="3" fill="#6b7280" text-anchor="start">${Math.round(value)}</text>
            `);
        }
        
        return gridLines.join('');
    }
    
    renderLine(dataset, labels, range, minValue, colorIndex) {
        const points = dataset.data.map((value, index) => {
            const x = (index / (labels.length - 1)) * 100;
            const y = 100 - ((value - minValue) / range) * 100;
            return `${x},${y}`;
        }).join(' ');
        
        const color = this.options.colors[colorIndex % this.options.colors.length];
        
        return `
            <polyline 
                points="${points}" 
                fill="none" 
                stroke="${color}" 
                stroke-width="2" 
                opacity="0.8"
                vector-effect="non-scaling-stroke"
            />
        `;
    }
    
    renderPoints(datasets, labels, range, minValue) {
        const points = [];
        
        datasets.forEach((dataset, datasetIndex) => {
            const color = this.options.colors[datasetIndex % this.options.colors.length];
            
            dataset.data.forEach((value, index) => {
                const x = (index / (labels.length - 1)) * 100;
                const y = 100 - ((value - minValue) / range) * 100;
                
                points.push(`
                    <circle 
                        cx="${x}" 
                        cy="${y}" 
                        r="1.5" 
                        fill="${color}" 
                        stroke="white" 
                        stroke-width="0.5"
                    />
                `);
            });
        });
        
        return points.join('');
    }
    
    renderBarChart() {
        const { labels, datasets } = this.data;
        const maxValue = Math.max(...datasets.flatMap(dataset => dataset.data));
        
        const chartHTML = `
            <div class="custom-chart-container" style="height: ${this.options.height}px; position: relative;">
                <div class="flex items-end justify-between h-full space-x-1">
                    ${labels.map((label, index) => {
                        const values = datasets.map(dataset => dataset.data[index]);
                        const maxBarValue = Math.max(...values);
                        const height = (maxBarValue / maxValue) * 100;
                        
                        return `
                            <div class="flex-1 flex flex-col items-center">
                                <div class="w-full bg-gray-200 rounded-t" style="height: ${height}%;">
                                    ${datasets.map((dataset, datasetIndex) => {
                                        const value = dataset.data[index];
                                        const barHeight = (value / maxValue) * 100;
                                        const color = this.options.colors[datasetIndex % this.options.colors.length];
                                        
                                        return `
                                            <div class="w-full rounded-t" style="height: ${barHeight}%; background-color: ${color}; opacity: 0.8;"></div>
                                        `;
                                    }).join('')}
                                </div>
                                <span class="text-xs text-gray-500 mt-1">${label}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        this.container.innerHTML = chartHTML;
    }
}
</script>
{% endblock %}

{% block content_title %}
<div class="flex items-center justify-between">
    <div class="flex items-center space-x-3">
        <div class="flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-400 to-teal-500 text-white shadow-lg">
            <i class="fas fa-utensils text-xl"></i>
        </div>
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">AI Calorie Tracker</h1>
            <p class="text-gray-600 text-sm sm:text-base">Free AI-powered nutrition analysis</p>
        </div>
    </div>
    <div class="flex items-center space-x-2">
        <button onclick="exportNutritionData('xlsx')" 
        class="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:outline-none
        <i class="fas fa-file-excel mr-2"></i>Export Excel
        </button>
        <div class="hidden sm:flex items-center space-x-2">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gradient-to-r from-green-400 to-emerald-400 text-white shadow-sm">
                <i class="fas fa-crown mr-1"></i>VIP Feature
            </span>
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                <i class="fas fa-free-code-camp mr-1"></i>100% Free
            </span>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Photo Analysis -->
        <div class="glass rounded-xl p-6 hover:shadow-lg transition-all duration-300 border border-emerald-100">
            <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-gradient-to-br from-emerald-100 to-teal-100 text-emerald-600 mb-4">
                <i class="fas fa-camera text-xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Advanced AI Food Recognition</h3>
            <p class="text-gray-600 text-sm mb-4">Upload a photo for superior AI food classification</p>
            <button onclick="openPhotoAnalysis()" class="w-full px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all">
                <i class="fas fa-camera mr-2"></i>Analyze Photo
            </button>
        </div>

        <!-- Search Food -->
        <div class="glass rounded-xl p-6 hover:shadow-lg transition-all duration-300 border border-blue-100">
            <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-gradient-to-br from-blue-100 to-indigo-100 text-blue-600 mb-4">
                <i class="fas fa-search text-xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Food Database</h3>
            <p class="text-gray-600 text-sm mb-4">Search 2.8M+ foods with nutrition data</p>
            <button onclick="openFoodSearch()" class="w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg hover:from-blue-600 hover:to-indigo-600 transition-all">
                <i class="fas fa-search mr-2"></i>Search Foods
            </button>
        </div>

        <!-- Manual Entry -->
        <div class="glass rounded-xl p-6 hover:shadow-lg transition-all duration-300 border border-purple-100">
            <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-gradient-to-br from-purple-100 to-pink-100 text-purple-600 mb-4">
                <i class="fas fa-edit text-xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Quick Entry</h3>
            <p class="text-gray-600 text-sm mb-4">Add food items manually</p>
            <button onclick="openManualEntry()" class="w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all">
                <i class="fas fa-edit mr-2"></i>Add Food
            </button>
        </div>
    </div>

    <!-- Today's Summary -->
    <div class="glass rounded-xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-chart-pie text-emerald-600 mr-2"></i>
                Today's Nutrition
            </h2>
            <div class="flex items-center space-x-2">
                <button onclick="viewMyNutritionPlans()" class="px-3 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all text-sm">
                    <i class="fas fa-clipboard-list mr-2"></i>View My Plans
                </button>
                <span class="text-sm text-gray-500" id="currentDate"></span>
            </div>
        </div>

        <!-- Macronutrient Progress -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="text-center">
                <div class="relative w-20 h-20 mx-auto mb-2">
                    <svg class="w-20 h-20 transform -rotate-90">
                        <circle cx="40" cy="40" r="36" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                        <circle cx="40" cy="40" r="36" stroke="#10b981" stroke-width="8" fill="none" 
                                stroke-dasharray="226" stroke-dashoffset="226" id="caloriesProgress" class="transition-all duration-1000"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-lg font-bold text-gray-900" id="caloriesPercent">0%</span>
                    </div>
                </div>
                <div class="text-sm font-medium text-gray-900" id="caloriesText">0 / 2000</div>
                <div class="text-xs text-gray-500">Calories</div>
            </div>

            <div class="text-center">
                <div class="relative w-20 h-20 mx-auto mb-2">
                    <svg class="w-20 h-20 transform -rotate-90">
                        <circle cx="40" cy="40" r="36" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                        <circle cx="40" cy="40" r="36" stroke="#3b82f6" stroke-width="8" fill="none" 
                                stroke-dasharray="226" stroke-dashoffset="226" id="proteinProgress" class="transition-all duration-1000"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-lg font-bold text-gray-900" id="proteinPercent">0%</span>
                    </div>
                </div>
                <div class="text-sm font-medium text-gray-900" id="proteinText">0g / 150g</div>
                <div class="text-xs text-gray-500">Protein</div>
            </div>

            <div class="text-center">
                <div class="relative w-20 h-20 mx-auto mb-2">
                    <svg class="w-20 h-20 transform -rotate-90">
                        <circle cx="40" cy="40" r="36" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                        <circle cx="40" cy="40" r="36" stroke="#f59e0b" stroke-width="8" fill="none" 
                                stroke-dasharray="226" stroke-dashoffset="226" id="carbsProgress" class="transition-all duration-1000"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-lg font-bold text-gray-900" id="carbsPercent">0%</span>
                    </div>
                </div>
                <div class="text-sm font-medium text-gray-900" id="carbsText">0g / 250g</div>
                <div class="text-xs text-gray-500">Carbs</div>
            </div>

            <div class="text-center">
                <div class="relative w-20 h-20 mx-auto mb-2">
                    <svg class="w-20 h-20 transform -rotate-90">
                        <circle cx="40" cy="40" r="36" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                        <circle cx="40" cy="40" r="36" stroke="#ef4444" stroke-width="8" fill="none" 
                                stroke-dasharray="226" stroke-dashoffset="226" id="fatProgress" class="transition-all duration-1000"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-lg font-bold text-gray-900" id="fatPercent">0%</span>
                    </div>
                </div>
                <div class="text-sm font-medium text-gray-900" id="fatText">0g / 70g</div>
                <div class="text-xs text-gray-500">Fat</div>
            </div>
        </div>

        <!-- AI Feedback -->
        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border border-emerald-100">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-100 text-emerald-600">
                        <i class="fas fa-robot text-sm"></i>
                    </div>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-medium text-emerald-800 mb-1">Smart Nutrition Coach</h4>
                    <p class="text-sm text-emerald-700" id="aiFeedback">Start logging your meals to get personalized nutrition advice!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Meal Planner -->
    <div class="glass rounded-xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-robot text-emerald-600 mr-2"></i>
                AI Meal Planner
            </h2>
            <div class="flex items-center space-x-2">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                    <i class="fas fa-crown mr-1"></i>Premium
                </span>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Generate Meal Plan -->
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-6 border border-purple-100">
                <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-gradient-to-br from-purple-100 to-pink-100 text-purple-600 mb-4">
                    <i class="fas fa-calendar-alt text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Personalized Meal Plan</h3>
                <p class="text-gray-600 text-sm mb-4">Get a complete 7-day meal plan tailored to your goals and preferences</p>
                <button onclick="openAIMealPlanModal()" class="w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all">
                    <i class="fas fa-magic mr-2"></i>Generate Plan
                </button>
            </div>

            <!-- Generate Custom Meal -->
            <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg p-6 border border-emerald-100">
                <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-gradient-to-br from-emerald-100 to-teal-100 text-emerald-600 mb-4">
                    <i class="fas fa-utensils text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Custom Meal Ideas</h3>
                <p class="text-gray-600 text-sm mb-4">Get AI-powered meal suggestions based on your preferences</p>
                <button onclick="openAICustomMealModal()" class="w-full px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all">
                    <i class="fas fa-lightbulb mr-2"></i>Get Ideas
                </button>
            </div>
        </div>

        <!-- AI Features Info -->
        <div class="mt-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-100">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-info text-sm"></i>
                    </div>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-medium text-blue-800 mb-1">AI-Powered Nutrition</h4>
                    <p class="text-sm text-blue-700">Our advanced AI creates personalized meal plans and suggestions based on your goals, dietary restrictions, and preferences. Available for Premium and VIP members.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Meals -->
    <div class="glass rounded-xl p-6 border border-gray-100">
        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-utensils text-emerald-600 mr-2"></i>
            Today's Meals
        </h2>
        
        <div class="space-y-4" id="todaysMeals">
            <!-- Meals will be loaded here -->
        </div>

        <div class="text-center text-gray-500 py-8" id="noMealsMessage">
            <i class="fas fa-utensils text-4xl mb-2 opacity-50"></i>
            <p>No meals logged today. Start by adding your first meal!</p>
        </div>
    </div>

    <!-- Weekly Progress -->
    <div class="glass rounded-xl p-6 border border-gray-100">
        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-chart-line text-emerald-600 mr-2"></i>
            Weekly Progress
        </h2>
        
        <!-- Chart Controls -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex space-x-2">
                <button id="caloriesChartBtn" onclick="switchChart('calories')" 
                        class="px-3 py-1 text-sm font-medium rounded-lg bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition-colors">
                    Calories
                </button>
                <button id="macrosChartBtn" onclick="switchChart('macros')" 
                        class="px-3 py-1 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                    Macros
                </button>
                <button id="goalsChartBtn" onclick="switchChart('goals')" 
                        class="px-3 py-1 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                    Goals
                </button>
            </div>
            <div class="text-sm text-gray-500">
                <span id="weekRange">This Week</span>
            </div>
        </div>
        
        <!-- Chart Container -->
        <div class="relative">
            <canvas id="weeklyChart" class="w-full h-64"></canvas>
            <div id="chartLoading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 hidden">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-emerald-600 text-xl mb-2"></i>
                    <p class="text-sm text-gray-600">Loading weekly data...</p>
                </div>
            </div>
        </div>
        
        <!-- Weekly Summary -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg border border-emerald-100">
                <div class="text-2xl font-bold text-emerald-600" id="weeklyAvgCalories">0</div>
                <div class="text-sm text-emerald-700">Avg Calories</div>
            </div>
            <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                <div class="text-2xl font-bold text-blue-600" id="weeklyAvgProtein">0g</div>
                <div class="text-sm text-blue-700">Avg Protein</div>
            </div>
            <div class="text-center p-4 bg-gradient-to-br from-orange-50 to-amber-50 rounded-lg border border-orange-100">
                <div class="text-2xl font-bold text-orange-600" id="weeklyAvgCarbs">0g</div>
                <div class="text-sm text-orange-700">Avg Carbs</div>
            </div>
            <div class="text-center p-4 bg-gradient-to-br from-red-50 to-pink-50 rounded-lg border border-red-100">
                <div class="text-2xl font-bold text-red-600" id="weeklyAvgFat">0g</div>
                <div class="text-sm text-red-700">Avg Fat</div>
            </div>
        </div>
        
        <!-- Weekly Insights -->
        <div class="mt-6 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border border-emerald-100">
            <h4 class="text-sm font-medium text-emerald-800 mb-2 flex items-center">
                <i class="fas fa-lightbulb text-emerald-600 mr-2"></i>
                Weekly Insights
            </h4>
            <p class="text-sm text-emerald-700" id="weeklyInsights">
                Start logging your meals to see weekly nutrition insights!
            </p>
        </div>
    </div>
</div>

<!-- Photo Analysis Modal -->
<div id="photoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Advanced AI Food Recognition</h3>
                <button onclick="closeModal('photoModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="photoForm" enctype="multipart/form-data">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Meal Type</label>
                        <select name="meal_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="Breakfast">Breakfast</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Snack">Snack</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Food Photo</label>
                        <input type="file" name="file" accept="image/*" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                               onchange="analyzePhotoWithHuggingFace(this)">
                        <p class="text-xs text-gray-500 mt-1">Our advanced AI will identify foods with superior accuracy</p>
                    </div>
                    
                    <!-- Photo Preview -->
                    <div id="photoPreview" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Photo Preview</label>
                        <img id="previewImage" class="w-full h-48 object-cover rounded-lg border border-gray-300">
                    </div>
                    
                    <!-- AI Detection Results -->
                    <div id="detectionResults" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">AI Detection Results</label>
                        <div id="detectedFoodsList" class="space-y-2">
                            <!-- Detected foods will appear here -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                        <textarea name="notes" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                  placeholder="Any additional details about your meal..."></textarea>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="closeModal('photoModal')" 
                                class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" id="submitPhotoBtn"
                                class="flex-1 px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all">
                            <i class="fas fa-save mr-2"></i>Save Meal
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Food Search Modal -->
<div id="searchModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Search Foods</h3>
                <button onclick="closeModal('searchModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <div class="flex space-x-2">
                    <input type="text" id="foodSearchQuery" placeholder="Search food or scan barcode..." 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="searchFood()" 
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Powered by Open Food Facts - 2.8M+ products</p>
            </div>
            
            <div id="searchResults" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- Search results will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Manual Entry Modal -->
<div id="manualModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add Food Manually</h3>
                <button onclick="closeModal('manualModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="manualForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Meal Type</label>
                        <select name="meal_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="Breakfast">Breakfast</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Snack">Snack</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Food Name</label>
                        <input type="text" name="food_name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                               placeholder="e.g., Grilled Chicken Breast">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                            <input type="number" name="quantity" step="0.1" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   placeholder="100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                            <select name="unit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="grams">Grams</option>
                                <option value="ml">ML</option>
                                <option value="pieces">Pieces</option>
                                <option value="cups">Cups</option>
                                <option value="tablespoons">Tablespoons</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Calories</label>
                        <input type="number" name="calories" step="0.1" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                               placeholder="165">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Protein (g)</label>
                            <input type="number" name="protein" step="0.1" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   placeholder="31">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Carbs (g)</label>
                            <input type="number" name="carbs" step="0.1" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   placeholder="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fat (g)</label>
                            <input type="number" name="fat" step="0.1" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   placeholder="3.6">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                        <textarea name="notes" rows="2" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                  placeholder="Any additional details..."></textarea>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="closeModal('manualModal')" 
                                class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all">
                            <i class="fas fa-plus mr-2"></i>Add Food
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- My Nutrition Plans Modal -->
<div id="myPlansModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">My Nutrition Plans</h3>
                <button onclick="closeModal('myPlansModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="myPlansContent">
                <!-- Member's nutrition plans will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Nutrition Comparison Modal -->
<div id="comparisonModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Plan vs Today Comparison</h3>
                <button onclick="closeModal('comparisonModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="comparisonContent">
                <!-- Comparison data will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- AI Meal Plan Modal -->
<div id="aiMealPlanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">AI Meal Plan Generator</h3>
                <button onclick="closeModal('aiMealPlanModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="aiMealPlanForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Plan Information -->
                    <div class="space-y-4">
                        <h4 class="text-md font-semibold text-gray-900 mb-3">Plan Information</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Plan Name</label>
                            <input type="text" name="plan_name" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   placeholder="e.g., My Weight Loss Plan, Summer Fitness Plan">
                            <p class="text-xs text-gray-500 mt-1">Give your meal plan a memorable name</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Age</label>
                                <input type="number" name="age" required min="13" max="120"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                       placeholder="25">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gender</label>
                                <select name="gender" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Weight (kg)</label>
                                <input type="number" name="weight" required step="0.1" min="30" max="300"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                       placeholder="70">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Height (cm)</label>
                                <input type="number" name="height" required min="100" max="250"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                       placeholder="170">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Activity Level</label>
                            <select name="activity_level" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Select Activity Level</option>
                                <option value="sedentary">Sedentary (little or no exercise)</option>
                                <option value="lightly_active">Lightly Active (light exercise 1-3 days/week)</option>
                                <option value="moderately_active">Moderately Active (moderate exercise 3-5 days/week)</option>
                                <option value="very_active">Very Active (hard exercise 6-7 days/week)</option>
                                <option value="extremely_active">Extremely Active (very hard exercise, physical job)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Goal</label>
                            <select name="goal" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Select Goal</option>
                                <option value="weight_loss">Weight Loss</option>
                                <option value="muscle_gain">Muscle Gain</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Preferences -->
                    <div class="space-y-4">
                        <h4 class="text-md font-semibold text-gray-900 mb-3">Preferences</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dietary Restrictions</label>
                            <textarea name="dietary_restrictions" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                      placeholder="e.g., vegetarian, gluten-free, dairy-free..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Allergies</label>
                            <textarea name="allergies" rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                      placeholder="e.g., nuts, shellfish, eggs..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Food Preferences</label>
                            <textarea name="preferences" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                      placeholder="e.g., prefer Mediterranean cuisine, love spicy food, avoid processed foods..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-6">
                    <button type="button" onclick="closeModal('aiMealPlanModal')" 
                            class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="generateMealPlanBtn"
                            class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all">
                        <i class="fas fa-magic mr-2"></i>Generate Meal Plan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- AI Custom Meal Modal -->
<div id="aiCustomMealModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Custom Meal Ideas</h3>
                <button onclick="closeModal('aiCustomMealModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="aiCustomMealForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Meal Type</label>
                        <select name="meal_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">Select Meal Type</option>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cuisine Style</label>
                        <select name="cuisine_style" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">Any Cuisine</option>
                            <option value="mediterranean">Mediterranean</option>
                            <option value="asian">Asian</option>
                            <option value="italian">Italian</option>
                            <option value="mexican">Mexican</option>
                            <option value="indian">Indian</option>
                            <option value="american">American</option>
                            <option value="vegetarian">Vegetarian</option>
                            <option value="vegan">Vegan</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Calorie Range</label>
                        <select name="calorie_range" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">Select Calorie Range</option>
                            <option value="low">Low (200-400 calories)</option>
                            <option value="medium">Medium (400-600 calories)</option>
                            <option value="high">High (600-800 calories)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dietary Preferences</label>
                        <textarea name="dietary_preferences" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                  placeholder="e.g., high protein, low carb, gluten-free..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ingredients to Include</label>
                        <textarea name="include_ingredients" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                  placeholder="e.g., chicken, quinoa, spinach..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ingredients to Avoid</label>
                        <textarea name="exclude_ingredients" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                  placeholder="e.g., dairy, nuts, shellfish..."></textarea>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-6">
                    <button type="button" onclick="closeModal('aiCustomMealModal')" 
                            class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="generateCustomMealBtn"
                            class="flex-1 px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all">
                        <i class="fas fa-lightbulb mr-2"></i>Generate Ideas
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- AI Meal Plan Results Modal -->
<div id="aiMealPlanResultsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Your Personalized Meal Plan</h3>
                <button onclick="closeModal('aiMealPlanResultsModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="aiMealPlanResults">
                <!-- AI meal plan results will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- AI Custom Meal Results Modal -->
<div id="aiCustomMealResultsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Custom Meal Ideas</h3>
                <button onclick="closeModal('aiCustomMealResultsModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="aiCustomMealResults">
                <!-- AI custom meal results will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let foodClassifier = null;
let detectedFoodsData = [];
let currentChartType = 'calories';
let weeklyData = null;

// Chart.js will be used for creating charts

// Initialize dashboard - use window.onload to ensure Chart.js is ready
window.onload = function() {
    console.log('Window loaded, checking libraries...');
    console.log('Chart.js available:', typeof Chart !== 'undefined');
    console.log('Hugging Face Transformers available:', typeof pipeline !== 'undefined');
    
    // Ensure Chart.js is loaded before proceeding
    if (typeof Chart === 'undefined') {
        console.warn('Chart.js not loaded, attempting to load from CDN...');
        loadChartJSFromCDN();
    } else {
        console.log('Chart.js loaded successfully');
        waitForChartJS(initializeDashboard);
    }
};

// Cleanup function to prevent memory leaks
window.addEventListener('beforeunload', function() {
    destroyWeeklyChart();
});

// Function to wait for Chart.js to be available
function waitForChartJS(callback, maxAttempts = 10) {
    let attempts = 0;
    
    function checkChartJS() {
        attempts++;
        console.log(`Checking Chart.js availability (attempt ${attempts}/${maxAttempts})...`);
        
        if (typeof Chart !== 'undefined' && typeof Chart === 'function') {
            console.log('Chart.js is now available!');
            callback();
        } else if (attempts >= maxAttempts) {
            console.error('Chart.js failed to load after maximum attempts');
            callback(); // Continue without Chart.js
        } else {
            setTimeout(checkChartJS, 500); // Check again in 500ms
        }
    }
    
    checkChartJS();
}

// Function to load Chart.js from CDN with fallback
function loadChartJSFromCDN() {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    script.onload = function() {
        console.log('Chart.js loaded successfully from CDN');
        waitForChartJS(initializeDashboard);
    };
    script.onerror = function() {
        console.error('Failed to load Chart.js from CDN, using fallback');
        // Try alternative CDN
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js';
        fallbackScript.onload = function() {
            console.log('Chart.js loaded successfully from fallback CDN');
            waitForChartJS(initializeDashboard);
        };
        fallbackScript.onerror = function() {
            console.error('All Chart.js CDN attempts failed');
            initializeDashboard(); // Continue without Chart.js
        };
        document.head.appendChild(fallbackScript);
    };
    
    // Add timeout to prevent hanging
    setTimeout(() => {
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js loading timeout, proceeding without it');
            initializeDashboard();
        }
    }, 5000); // 5 second timeout
    
    document.head.appendChild(script);
}

// Initialize dashboard components
function initializeDashboard() {
    // Double-check Chart.js is available before proceeding
    if (typeof Chart === 'undefined') {
        console.error('Chart.js still not available in initializeDashboard');
        // Continue without Chart.js
    } else {
        console.log('Chart.js confirmed available in initializeDashboard');
    }
    
    loadNutritionDashboard();
    updateCurrentDate();
    loadFoodClassifier();
    loadWeeklyProgress();
    
    // Test Chart.js availability after a short delay
    setTimeout(() => {
        testChartJS();
    }, 2000);
}

// Load Hugging Face food classification model
async function loadFoodClassifier() {
    try {
        console.log('Loading Hugging Face food classification model...');
        if (typeof pipeline !== 'undefined') {
            foodClassifier = await pipeline('image-classification', 'nateraw/food');
            console.log('Hugging Face food classifier loaded successfully!');
        } else {
            console.warn('Hugging Face Transformers.js not available - photo analysis will be limited');
        }
    } catch (error) {
        console.error('Error loading Hugging Face model:', error);
        console.warn('Photo analysis will work with manual food entry only');
    }
}

function updateCurrentDate() {
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', options);
}

async function loadNutritionDashboard() {
    try {
        const response = await fetch(`/api/nutrition/dashboard/{{ user.id if user else 1 }}`);
        const data = await response.json();
        
        if (data.success) {
            updateNutritionProgress(data.today);
            loadTodaysMeals(data.today.meals);
            
            if (data.today.totals.calories > 0) {
                document.getElementById('aiFeedback').textContent = 
                    data.weekly_analysis[0]?.ai_feedback || 'Great job tracking your nutrition today!';
            }
        }
    } catch (error) {
        console.error('Error loading nutrition dashboard:', error);
    }
}

// Hugging Face Food Analysis
async function analyzePhotoWithHuggingFace(fileInput) {
    if (!fileInput.files || !fileInput.files[0]) return;
    
    const file = fileInput.files[0];
    const imageUrl = URL.createObjectURL(file);
    
    // Show preview
    const preview = document.getElementById('photoPreview');
    const previewImage = document.getElementById('previewImage');
    previewImage.src = imageUrl;
    preview.classList.remove('hidden');
    
    // Show loading state
    const resultsDiv = document.getElementById('detectionResults');
    const foodsList = document.getElementById('detectedFoodsList');
    foodsList.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-emerald-600"></i><p class="text-sm text-gray-600 mt-2">Analyzing food with AI...</p></div>';
    resultsDiv.classList.remove('hidden');
    
    try {
        if (!foodClassifier) {
            await loadFoodClassifier();
        }
        
        // Check if Hugging Face model is available
        if (!foodClassifier || typeof pipeline === 'undefined') {
            console.warn('Hugging Face model not available - using fallback food detection');
            // Use fallback food detection
            detectedFoodsData = [{
                name: "Food Item (Manual Entry Recommended)",
                quantity: 100,
                calories: 200,
                protein: 8,
                carbs: 25,
                fat: 8,
                confidence: 0.5
            }];
            displayDetectedFoods(detectedFoodsData);
            return;
        }
        
        // Create image element for Hugging Face
        const img = new Image();
        img.onload = async () => {
            try {
                // Get predictions from Hugging Face model
                const predictions = await foodClassifier(img);
                
                // Process predictions to extract food items
                const foodPredictions = filterHuggingFacePredictions(predictions);
                
                if (foodPredictions.length > 0) {
                    detectedFoodsData = await estimateNutritionFromHuggingFacePredictions(foodPredictions);
                    displayDetectedFoods(detectedFoodsData);
                } else {
                    // No food detected
                    detectedFoodsData = [{
                        name: "Unknown Food Item",
                        quantity: 100,
                        calories: 200,
                        protein: 5,
                        carbs: 20,
                        fat: 10,
                        confidence: 0.3
                    }];
                    displayDetectedFoods(detectedFoodsData);
                }
            } catch (error) {
                console.error('Error analyzing photo:', error);
                showErrorInResults();
            }
        };
        img.src = imageUrl;
        
    } catch (error) {
        console.error('Error with Hugging Face analysis:', error);
        showErrorInResults();
    }
}

function filterHuggingFacePredictions(predictions) {
    // Debug: Log all predictions to see what Hugging Face model is detecting
    console.log(' Hugging Face Food Predictions:', predictions.map(p => ({
        name: p.label,
        confidence: Math.round(p.score * 100) + '%'
    })));
    
    // The nateraw/food model is specifically trained on Food101 dataset
    // All predictions are food-related, so we can trust them more
    const foodPredictions = predictions.filter(pred => pred.score > 0.1);
    
    console.log(' Filtered Food Predictions:', foodPredictions.map(p => ({
        name: p.label,
        confidence: Math.round(p.score * 100) + '%'
    })));
    
    return foodPredictions.slice(0, 3); // Take top 3 predictions
}

async function estimateNutritionFromHuggingFacePredictions(predictions) {
    // Comprehensive nutrition database for Food101 categories
    const nutritionDatabase = {
        // Fruits
        'apple_pie': { calories: 237, protein: 2.4, carbs: 34, fat: 11, defaultGrams: 100 },
        'banana': { calories: 89, protein: 1.1, carbs: 23, fat: 0.3, defaultGrams: 120 },
        'orange': { calories: 47, protein: 0.9, carbs: 12, fat: 0.1, defaultGrams: 130 },
        'strawberry': { calories: 32, protein: 0.7, carbs: 8, fat: 0.3, defaultGrams: 100 },
        'pineapple': { calories: 50, protein: 0.5, carbs: 13, fat: 0.1, defaultGrams: 100 },
        'watermelon': { calories: 30, protein: 0.6, carbs: 8, fat: 0.2, defaultGrams: 200 },
        
        // Vegetables
        'broccoli': { calories: 34, protein: 2.8, carbs: 7, fat: 0.4, defaultGrams: 100 },
        'carrot': { calories: 41, protein: 0.9, carbs: 10, fat: 0.2, defaultGrams: 80 },
        'cucumber': { calories: 16, protein: 0.7, carbs: 4, fat: 0.1, defaultGrams: 100 },
        'bell_pepper': { calories: 31, protein: 1, carbs: 7, fat: 0.3, defaultGrams: 80 },
        'mushroom': { calories: 22, protein: 3.1, carbs: 3, fat: 0.3, defaultGrams: 70 },
        'corn': { calories: 86, protein: 3.3, carbs: 19, fat: 1.4, defaultGrams: 100 },
        'potato': { calories: 77, protein: 2, carbs: 17, fat: 0.1, defaultGrams: 150 },
        
        // Meats
        'beef_carpaccio': { calories: 250, protein: 26, carbs: 0, fat: 15, defaultGrams: 100 },
        'beef_tartare': { calories: 250, protein: 26, carbs: 0, fat: 15, defaultGrams: 100 },
        'chicken_curry': { calories: 200, protein: 25, carbs: 8, fat: 10, defaultGrams: 150 },
        'chicken_wings': { calories: 290, protein: 27, carbs: 0, fat: 19, defaultGrams: 100 },
        'fish_and_chips': { calories: 350, protein: 15, carbs: 35, fat: 18, defaultGrams: 200 },
        'hamburger': { calories: 540, protein: 25, carbs: 40, fat: 31, defaultGrams: 200 },
        'hot_dog': { calories: 290, protein: 11, carbs: 3, fat: 26, defaultGrams: 100 },
        'pizza': { calories: 285, protein: 12, carbs: 36, fat: 10, defaultGrams: 150 },
        'steak': { calories: 250, protein: 26, carbs: 0, fat: 15, defaultGrams: 150 },
        
        // Breads and Grains
        'bagel': { calories: 250, protein: 10, carbs: 49, fat: 1.5, defaultGrams: 90 },
        'bread': { calories: 265, protein: 9, carbs: 49, fat: 3.2, defaultGrams: 50 },
        'french_fries': { calories: 365, protein: 4, carbs: 63, fat: 17, defaultGrams: 100 },
        'french_toast': { calories: 229, protein: 7, carbs: 25, fat: 12, defaultGrams: 100 },
        'pancakes': { calories: 227, protein: 6, carbs: 35, fat: 9, defaultGrams: 100 },
        'waffles': { calories: 291, protein: 8, carbs: 38, fat: 14, defaultGrams: 100 },
        
        // Desserts
        'apple_pie': { calories: 237, protein: 2.4, carbs: 34, fat: 11, defaultGrams: 100 },
        'cheesecake': { calories: 321, protein: 6, carbs: 26, fat: 23, defaultGrams: 100 },
        'chocolate_cake': { calories: 371, protein: 5, carbs: 45, fat: 20, defaultGrams: 100 },
        'chocolate_mousse': { calories: 225, protein: 4, carbs: 20, fat: 15, defaultGrams: 100 },
        'donuts': { calories: 253, protein: 4, carbs: 31, fat: 13, defaultGrams: 60 },
        'ice_cream': { calories: 207, protein: 3.5, carbs: 24, fat: 11, defaultGrams: 100 },
        'tiramisu': { calories: 285, protein: 6, carbs: 28, fat: 18, defaultGrams: 100 },
        
        // Other foods
        'sushi': { calories: 150, protein: 6, carbs: 30, fat: 1, defaultGrams: 100 },
        'tacos': { calories: 226, protein: 9, carbs: 26, fat: 12, defaultGrams: 100 },
        'spaghetti_carbonara': { calories: 400, protein: 15, carbs: 45, fat: 20, defaultGrams: 200 },
        'ramen': { calories: 350, protein: 12, carbs: 60, fat: 8, defaultGrams: 300 },
        'salad': { calories: 25, protein: 2, carbs: 5, fat: 0.3, defaultGrams: 100 },
        
        // Default for unknown items
        'default': { calories: 200, protein: 8, carbs: 25, fat: 8, defaultGrams: 100 }
    };
    
    return predictions.map(pred => {
        const foodName = pred.label.toLowerCase().replace(/[^a-z0-9]/g, '_');
        let nutritionData = nutritionDatabase['default'];
        let matchedKey = 'default';
        
        console.log(` Trying to match: "${foodName}"`);
        
        // Find matching nutrition data
        for (const [key, data] of Object.entries(nutritionDatabase)) {
            if (key === 'default') continue;
            
            // Try exact match first
            if (foodName === key) {
                nutritionData = data;
                matchedKey = key;
                console.log(` Exact match found: ${key}`);
                break;
            }
            
            // Try partial matches
            if (foodName.includes(key) || key.includes(foodName)) {
                nutritionData = data;
                matchedKey = key;
                console.log(` Partial match found: ${key}`);
                break;
            }
        }
        
        console.log(` Final match for "${foodName}": ${matchedKey}`);
        
        return {
            name: pred.label,
            quantity: nutritionData.defaultGrams,
            calories: Math.round(nutritionData.calories * (nutritionData.defaultGrams / 100)),
            protein: Math.round(nutritionData.protein * (nutritionData.defaultGrams / 100) * 10) / 10,
            carbs: Math.round(nutritionData.carbs * (nutritionData.defaultGrams / 100) * 10) / 10,
            fat: Math.round(nutritionData.fat * (nutritionData.defaultGrams / 100) * 10) / 10,
            confidence: pred.score
        };
    });
}

function displayDetectedFoods(foods) {
    const foodsList = document.getElementById('detectedFoodsList');
    
    foodsList.innerHTML = foods.map((food, index) => `
        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h4 class="font-medium text-gray-900">${food.name}</h4>
                    <p class="text-xs text-gray-500">Confidence: ${Math.round(food.confidence * 100)}%</p>
                </div>
                <button onclick="removeFoodItem(${index})" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                <div>
                    <input type="number" value="${food.quantity}" onchange="updateFoodQuantity(${index}, this.value)" 
                           class="w-16 px-1 py-0.5 border border-gray-300 rounded text-xs">g
                </div>
                <div>${food.calories} cal</div>
                <div>P: ${food.protein}g</div>
                <div>C: ${food.carbs}g | F: ${food.fat}g</div>
            </div>
        </div>
    `).join('');
    
    if (foods.length > 0) {
        document.getElementById('submitPhotoBtn').innerHTML = '<i class="fas fa-save mr-2"></i>Save Meal';
        document.getElementById('submitPhotoBtn').disabled = false;
    }
}

function showErrorInResults() {
    const foodsList = document.getElementById('detectedFoodsList');
    foodsList.innerHTML = `
        <div class="text-center py-4 text-gray-500">
            <i class="fas fa-exclamation-triangle text-yellow-500 mb-2"></i>
            <p class="text-sm">Couldn't identify foods in this photo</p>
            <p class="text-xs">You can still save it and add details manually</p>
        </div>
    `;
    
    detectedFoodsData = [{
        name: "Unknown Food Item",
        quantity: 100,
        calories: 0,
        protein: 0,
        carbs: 0,
        fat: 0,
        confidence: 0.1
    }];
    
    document.getElementById('submitPhotoBtn').innerHTML = '<i class="fas fa-save mr-2"></i>Save Anyway';
    document.getElementById('submitPhotoBtn').disabled = false;
}

function removeFoodItem(index) {
    detectedFoodsData.splice(index, 1);
    displayDetectedFoods(detectedFoodsData);
}

function updateFoodQuantity(index, newQuantity) {
    if (detectedFoodsData[index]) {
        const ratio = newQuantity / detectedFoodsData[index].quantity;
        detectedFoodsData[index].quantity = parseFloat(newQuantity);
        detectedFoodsData[index].calories = Math.round(detectedFoodsData[index].calories * ratio);
        detectedFoodsData[index].protein = Math.round(detectedFoodsData[index].protein * ratio * 10) / 10;
        detectedFoodsData[index].carbs = Math.round(detectedFoodsData[index].carbs * ratio * 10) / 10;
        detectedFoodsData[index].fat = Math.round(detectedFoodsData[index].fat * ratio * 10) / 10;
        displayDetectedFoods(detectedFoodsData);
    }
}

function updateNutritionProgress(todayData) {
    const { totals, goals, progress } = todayData;
    
    // Update progress circles
    updateProgressCircle('calories', progress.calories, totals.calories, goals.daily_calorie_goal);
    updateProgressCircle('protein', progress.protein, totals.protein, goals.daily_protein_goal, 'g');
    updateProgressCircle('carbs', progress.carbs, totals.carbs, goals.daily_carbs_goal, 'g');
    updateProgressCircle('fat', progress.fat, totals.fat, goals.daily_fat_goal, 'g');
}

function updateProgressCircle(type, percentage, current, goal, unit = '') {
    const circle = document.getElementById(`${type}Progress`);
    const percentElement = document.getElementById(`${type}Percent`);
    const textElement = document.getElementById(`${type}Text`);
    
    const circumference = 226; // 2 *  * 36
    const offset = circumference - (Math.min(percentage, 100) / 100) * circumference;
    
    circle.style.strokeDashoffset = offset;
    percentElement.textContent = `${Math.round(percentage)}%`;
    textElement.textContent = `${Math.round(current)}${unit} / ${Math.round(goal)}${unit}`;
}

function loadTodaysMeals(meals) {
    const container = document.getElementById('todaysMeals');
    const noMealsMessage = document.getElementById('noMealsMessage');
    
    if (meals.length === 0) {
        container.style.display = 'none';
        noMealsMessage.style.display = 'block';
        return;
    }
    
    container.style.display = 'block';
    noMealsMessage.style.display = 'none';
    
    container.innerHTML = meals.map(meal => `
        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-white rounded-lg border border-gray-200">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center">
                    <i class="fas ${getMealIcon(meal.meal_type)}"></i>
                </div>
                <div>
                    <h4 class="font-medium text-gray-900">${meal.meal_type}</h4>
                    <p class="text-sm text-gray-600">${Math.round(meal.calories)} calories</p>
                </div>
            </div>
            <div class="text-right text-sm text-gray-600">
                <div>P: ${Math.round(meal.protein)}g</div>
                <div>C: ${Math.round(meal.carbs)}g  F: ${Math.round(meal.fat)}g</div>
            </div>
        </div>
    `).join('');
}

function getMealIcon(mealType) {
    const icons = {
        'Breakfast': 'fa-coffee',
        'Lunch': 'fa-hamburger',
        'Dinner': 'fa-utensils',
        'Snack': 'fa-cookie-bite'
    };
    return icons[mealType] || 'fa-utensils';
}

// Modal functions
function openPhotoAnalysis() {
    document.getElementById('photoModal').classList.remove('hidden');
    // Reset form
    document.getElementById('photoPreview').classList.add('hidden');
    document.getElementById('detectionResults').classList.add('hidden');
    detectedFoodsData = [];
}

function openFoodSearch() {
    document.getElementById('searchModal').classList.remove('hidden');
}

function openManualEntry() {
    document.getElementById('manualModal').classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

// View my nutrition plans
async function viewMyNutritionPlans() {
    try {
        const response = await fetch('/api/member/nutrition/plans');
        const data = await response.json();
        
        if (data.success) {
            showMyNutritionPlans(data);
        } else {
            showNotification(data.detail || 'Failed to load nutrition plans', 'error');
        }
    } catch (error) {
        console.error('Error loading nutrition plans:', error);
        showNotification('Error loading nutrition plans', 'error');
    }
}

// Show my nutrition plans modal
function showMyNutritionPlans(data) {
    const modal = document.getElementById('myPlansModal');
    const content = document.getElementById('myPlansContent');
    
    const plans = data.plans || [];
    
    content.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center">
                    <i class="fas fa-clipboard-list text-xl"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900">My Nutrition Plans</h4>
                    <p class="text-sm text-gray-600">Personalized nutrition plans from your coach</p>
                </div>
            </div>
            
            ${plans.length === 0 ? `
                <div class="text-center py-8">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-clipboard-list text-gray-400 text-2xl"></i>
                    </div>
                    <h5 class="text-lg font-medium text-gray-900 mb-2">No Nutrition Plans Yet</h5>
                    <p class="text-gray-600">Your coach hasn't created any nutrition plans for you yet.</p>
                    <p class="text-sm text-gray-500 mt-2">Contact your coach to get a personalized nutrition plan!</p>
                </div>
            ` : `
                <div class="space-y-4">
                    ${plans.map(plan => `
                        <div class="border border-gray-200 rounded-lg p-6 bg-gradient-to-r from-purple-50 to-pink-50">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h5 class="text-lg font-semibold text-gray-900">${plan.plan_name}</h5>
                                    <p class="text-sm text-gray-600">Created: ${new Date(plan.created_at).toLocaleDateString()}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${
                                        plan.status === 'active' ? 'bg-green-100 text-green-800' :
                                        plan.status === 'completed' ? 'bg-blue-100 text-blue-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">
                                        ${plan.status.charAt(0).toUpperCase() + plan.status.slice(1)}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600">${plan.daily_calories}</div>
                                    <div class="text-sm text-gray-600">Daily Calories</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">${plan.daily_protein}g</div>
                                    <div class="text-sm text-gray-600">Daily Protein</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${plan.daily_carbs}g</div>
                                    <div class="text-sm text-gray-600">Daily Carbs</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-600">${plan.daily_fat}g</div>
                                    <div class="text-sm text-gray-600">Daily Fat</div>
                                </div>
                            </div>
                            
                            ${plan.notes ? `
                                <div class="mt-4 p-3 bg-white rounded-lg border border-gray-200">
                                    <h6 class="text-sm font-medium text-gray-900 mb-2">Coach's Notes:</h6>
                                    <p class="text-sm text-gray-700">${plan.notes}</p>
                                </div>
                            ` : ''}
                            
                            <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                                <div class="text-sm text-gray-600">
                                    Last updated: ${new Date(plan.updated_at).toLocaleDateString()}
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="deleteNutritionPlan(${plan.id}, '${plan.plan_name}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                        <i class="fas fa-trash mr-1"></i>Delete Plan
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Compare plan with today's nutrition
async function compareWithToday(planId, planData) {
    try {
        // Parse the plan data
        const plan = typeof planData === 'string' ? JSON.parse(planData) : planData;
        
        // Get today's nutrition data
        const response = await fetch('/api/member/nutrition/today');
        const data = await response.json();
        
        if (data.success) {
            showComparisonModal(plan, data.today, data.meals);
        } else {
            showNotification(data.detail || 'Failed to load today\'s nutrition data', 'error');
        }
    } catch (error) {
        console.error('Error comparing with today:', error);
        showNotification('Error loading comparison data', 'error');
    }
}

// Show comparison modal
function showComparisonModal(plan, todayData, mealsData) {
    const modal = document.getElementById('comparisonModal');
    const content = document.getElementById('comparisonContent');
    
    // Calculate percentages and differences
    const caloriesPercent = Math.round((todayData.total_calories / plan.daily_calories) * 100);
    const proteinPercent = Math.round((todayData.total_protein / plan.daily_protein) * 100);
    const carbsPercent = Math.round((todayData.total_carbs / plan.daily_carbs) * 100);
    const fatPercent = Math.round((todayData.total_fat / plan.daily_fat) * 100);
    
    const caloriesDiff = todayData.total_calories - plan.daily_calories;
    const proteinDiff = todayData.total_protein - plan.daily_protein;
    const carbsDiff = todayData.total_carbs - plan.daily_carbs;
    const fatDiff = todayData.total_fat - plan.daily_fat;
    
    content.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900">${plan.plan_name}</h4>
                    <p class="text-sm text-gray-600">Plan vs Today's Actual Intake</p>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-purple-800">Calories</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            caloriesPercent >= 90 && caloriesPercent <= 110 ? 'bg-green-100 text-green-800' :
                            caloriesPercent < 90 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                        }">
                            ${caloriesPercent}%
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-purple-600">${Math.round(todayData.total_calories)}</div>
                    <div class="text-sm text-purple-600">/ ${plan.daily_calories} cal</div>
                    <div class="text-xs text-gray-600 mt-1">
                        ${caloriesDiff > 0 ? '+' : ''}${Math.round(caloriesDiff)} cal ${caloriesDiff > 0 ? 'over' : 'under'}
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-blue-800">Protein</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            proteinPercent >= 90 && proteinPercent <= 110 ? 'bg-green-100 text-green-800' :
                            proteinPercent < 90 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                        }">
                            ${proteinPercent}%
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-blue-600">${Math.round(todayData.total_protein)}g</div>
                    <div class="text-sm text-blue-600">/ ${plan.daily_protein}g</div>
                    <div class="text-xs text-gray-600 mt-1">
                        ${proteinDiff > 0 ? '+' : ''}${Math.round(proteinDiff)}g ${proteinDiff > 0 ? 'over' : 'under'}
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-green-800">Carbs</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            carbsPercent >= 90 && carbsPercent <= 110 ? 'bg-green-100 text-green-800' :
                            carbsPercent < 90 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                        }">
                            ${carbsPercent}%
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-green-600">${Math.round(todayData.total_carbs)}g</div>
                    <div class="text-sm text-green-600">/ ${plan.daily_carbs}g</div>
                    <div class="text-xs text-gray-600 mt-1">
                        ${carbsDiff > 0 ? '+' : ''}${Math.round(carbsDiff)}g ${carbsDiff > 0 ? 'over' : 'under'}
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-sm font-medium text-orange-800">Fat</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            fatPercent >= 90 && fatPercent <= 110 ? 'bg-green-100 text-green-800' :
                            fatPercent < 90 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                        }">
                            ${fatPercent}%
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-orange-600">${Math.round(todayData.total_fat)}g</div>
                    <div class="text-sm text-orange-600">/ ${plan.daily_fat}g</div>
                    <div class="text-xs text-gray-600 mt-1">
                        ${fatDiff > 0 ? '+' : ''}${Math.round(fatDiff)}g ${fatDiff > 0 ? 'over' : 'under'}
                    </div>
                </div>
            </div>
            
            <!-- Progress Bars -->
            <div class="space-y-4">
                <h5 class="text-lg font-semibold text-gray-900">Progress Towards Plan Goals</h5>
                
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Calories</span>
                            <span>${Math.round(todayData.total_calories)} / ${plan.daily_calories}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-500 ${
                                caloriesPercent >= 100 ? 'bg-green-500' : 
                                caloriesPercent >= 80 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${Math.min(caloriesPercent, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Protein</span>
                            <span>${Math.round(todayData.total_protein)}g / ${plan.daily_protein}g</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-500 ${
                                proteinPercent >= 100 ? 'bg-green-500' : 
                                proteinPercent >= 80 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${Math.min(proteinPercent, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Carbs</span>
                            <span>${Math.round(todayData.total_carbs)}g / ${plan.daily_carbs}g</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-500 ${
                                carbsPercent >= 100 ? 'bg-green-500' : 
                                carbsPercent >= 80 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${Math.min(carbsPercent, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Fat</span>
                            <span>${Math.round(todayData.total_fat)}g / ${plan.daily_fat}g</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-500 ${
                                fatPercent >= 100 ? 'bg-green-500' : 
                                fatPercent >= 80 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${Math.min(fatPercent, 100)}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Today's Meals Breakdown -->
            <div class="space-y-4">
                <h5 class="text-lg font-semibold text-gray-900">Today's Meals Breakdown</h5>
                
                ${mealsData.length === 0 ? `
                    <div class="text-center py-6 bg-gray-50 rounded-lg">
                        <i class="fas fa-utensils text-gray-400 text-2xl mb-2"></i>
                        <p class="text-gray-600">No meals logged today yet</p>
                        <p class="text-sm text-gray-500">Start logging your meals to see the breakdown</p>
                    </div>
                ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        ${mealsData.map(meal => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h6 class="font-medium text-gray-900">${meal.meal_type}</h6>
                                    <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                                        ${meal.entries_count} items
                                    </span>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Calories:</span>
                                        <span class="font-medium">${Math.round(meal.total_calories)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Protein:</span>
                                        <span class="font-medium">${Math.round(meal.total_protein)}g</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Carbs:</span>
                                        <span class="font-medium">${Math.round(meal.total_carbs)}g</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Fat:</span>
                                        <span class="font-medium">${Math.round(meal.total_fat)}g</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
            
            <!-- Recommendations -->
            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border border-emerald-200">
                <h5 class="text-lg font-semibold text-emerald-800 mb-3">Smart Recommendations</h5>
                <div class="space-y-2">
                    ${generateRecommendations(plan, todayData)}
                </div>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Generate smart recommendations based on comparison
function generateRecommendations(plan, todayData) {
    const recommendations = [];
    
    const caloriesPercent = (todayData.total_calories / plan.daily_calories) * 100;
    const proteinPercent = (todayData.total_protein / plan.daily_protein) * 100;
    const carbsPercent = (todayData.total_carbs / plan.daily_carbs) * 100;
    const fatPercent = (todayData.total_fat / plan.daily_fat) * 100;
    
    if (caloriesPercent < 80) {
        recommendations.push(' <strong>Add more calories:</strong> Consider having a healthy snack or increasing portion sizes.');
    } else if (caloriesPercent > 120) {
        recommendations.push(' <strong>Reduce calorie intake:</strong> Try smaller portions or choose lower-calorie options.');
    }
    
    if (proteinPercent < 80) {
        recommendations.push(' <strong>Increase protein:</strong> Add lean meats, fish, eggs, or plant-based protein sources.');
    }
    
    if (carbsPercent < 80) {
        recommendations.push(' <strong>Add more carbs:</strong> Include whole grains, fruits, or starchy vegetables.');
    } else if (carbsPercent > 120) {
        recommendations.push(' <strong>Reduce carbs:</strong> Consider replacing some carbs with protein or healthy fats.');
    }
    
    if (fatPercent < 80) {
        recommendations.push(' <strong>Add healthy fats:</strong> Include nuts, avocados, or olive oil in your meals.');
    } else if (fatPercent > 120) {
        recommendations.push(' <strong>Reduce fat intake:</strong> Choose leaner protein sources and limit added fats.');
    }
    
    if (recommendations.length === 0) {
        recommendations.push(' <strong>Great job!</strong> You\'re staying close to your nutrition plan goals.');
    }
    
    return recommendations.map(rec => `<p class="text-sm text-emerald-700">${rec}</p>`).join('');
}

// Photo analysis form
document.getElementById('photoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    formData.append('detected_foods', JSON.stringify(detectedFoodsData));
    
    const submitBtn = this.querySelector('button[type="submit"]');
    
    try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        
        const response = await fetch('/api/nutrition/analyze-photo', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Photo and meal data saved successfully!', 'success');
            closeModal('photoModal');
            loadNutritionDashboard();
            refreshWeeklyProgress();
            this.reset();
        } else {
            showNotification(data.detail || 'Failed to save meal', 'error');
        }
    } catch (error) {
        console.error('Error saving photo meal:', error);
        showNotification('Error saving meal', 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Meal';
    }
});

// Food search
async function searchFood() {
    const query = document.getElementById('foodSearchQuery').value.trim();
    if (!query) return;
    
    try {
        const response = await fetch(`/api/nutrition/search-food?query=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.success) {
            displaySearchResults(data.foods);
        }
    } catch (error) {
        console.error('Error searching food:', error);
        showNotification('Error searching food', 'error');
    }
}

function displaySearchResults(foods) {
    const container = document.getElementById('searchResults');
    
    if (foods.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">No foods found</p>';
        return;
    }
    
    container.innerHTML = foods.map(food => `
        <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="selectFood(${JSON.stringify(food).replace(/"/g, '&quot;')})">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-medium text-gray-900">${food.name}</h4>
                    <p class="text-sm text-gray-600">${food.brand}</p>
                    <p class="text-xs text-blue-600">Open Food Facts</p>
                </div>
                <div class="text-sm text-gray-600 text-right">
                    <div>${food.calories_per_100g} cal/100g</div>
                    <div class="text-xs">P:${food.protein_per_100g}g C:${food.carbs_per_100g}g F:${food.fat_per_100g}g</div>
                </div>
            </div>
        </div>
    `).join('');
}

function selectFood(food) {
    // Fill manual form with selected food data
    closeModal('searchModal');
    openManualEntry();
    
    const form = document.getElementById('manualForm');
    form.food_name.value = food.name;
    form.quantity.value = 100;
    form.calories.value = food.calories_per_100g;
    form.protein.value = food.protein_per_100g;
    form.carbs.value = food.carbs_per_100g;
    form.fat.value = food.fat_per_100g;
}

// Manual food entry
document.getElementById('manualForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    
    try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';
        
        const response = await fetch('/api/nutrition/add-food', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Food added successfully!', 'success');
            closeModal('manualModal');
            loadNutritionDashboard();
            refreshWeeklyProgress();
            this.reset();
        } else {
            showNotification(data.detail || 'Failed to add food', 'error');
        }
    } catch (error) {
        console.error('Error adding food:', error);
        showNotification('Error adding food', 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Food';
    }
});

// Utility functions
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.remove('translate-x-full'), 100);
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
}

// Enter key search
document.getElementById('foodSearchQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchFood();
    }
});

// Weekly Progress Functions
async function loadWeeklyProgress() {
    try {
        showChartLoading(true);
        const response = await fetch(`/api/nutrition/weekly-progress/{{ user.id if user else 1 }}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            weeklyData = data.weekly_data;
            updateWeeklySummary(data.weekly_data);
            updateWeeklyInsights(data.weekly_data);
            
            // Ensure Chart.js is available before creating chart
            if (typeof Chart !== 'undefined' && typeof Chart === 'function') {
                createWeeklyChart(data.weekly_data);
            } else {
                console.warn('Chart.js not available for chart creation, showing fallback');
                showChartLoading(false);
                showFallbackContent(data.weekly_data);
            }
            
            updateWeekRange();
        } else {
            throw new Error(data.detail || 'Failed to load weekly data');
        }
    } catch (error) {
        console.error('Error loading weekly progress:', error);
        showChartLoading(false);
        
        // Show fallback content
        const chartContainer = document.getElementById('weeklyChart').parentElement;
        chartContainer.innerHTML = `
            <div class="h-64 flex items-center justify-center text-gray-500">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-2"></i>
                    <p>Unable to load weekly progress data</p>
                    <p class="text-sm mt-2">Please try refreshing the page or contact support</p>
                </div>
            </div>
        `;
        
        // Update insights with error message
        document.getElementById('weeklyInsights').textContent = 'Weekly progress data is currently unavailable. Please try again later.';
    }
}

function showChartLoading(show) {
    const loading = document.getElementById('chartLoading');
    if (show) {
        loading.classList.remove('hidden');
    } else {
        loading.classList.add('hidden');
    }
}

function updateWeekRange() {
    const today = new Date();
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay());
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    
    const options = { month: 'short', day: 'numeric' };
    const startStr = weekStart.toLocaleDateString('en-US', options);
    const endStr = weekEnd.toLocaleDateString('en-US', options);
    
    document.getElementById('weekRange').textContent = `${startStr} - ${endStr}`;
}

function updateWeeklySummary(weeklyData) {
    if (!weeklyData || weeklyData.length === 0) return;
    
    const daysWithData = weeklyData.filter(day => day.calories > 0);
    if (daysWithData.length === 0) return;
    
    const avgCalories = Math.round(daysWithData.reduce((sum, day) => sum + day.calories, 0) / daysWithData.length);
    const avgProtein = Math.round(daysWithData.reduce((sum, day) => sum + day.protein, 0) / daysWithData.length);
    const avgCarbs = Math.round(daysWithData.reduce((sum, day) => sum + day.carbs, 0) / daysWithData.length);
    const avgFat = Math.round(daysWithData.reduce((sum, day) => sum + day.fat, 0) / daysWithData.length);
    
    document.getElementById('weeklyAvgCalories').textContent = avgCalories;
    document.getElementById('weeklyAvgProtein').textContent = avgProtein + 'g';
    document.getElementById('weeklyAvgCarbs').textContent = avgCarbs + 'g';
    document.getElementById('weeklyAvgFat').textContent = avgFat + 'g';
}

function updateWeeklyInsights(weeklyData) {
    if (!weeklyData || weeklyData.length === 0) {
        document.getElementById('weeklyInsights').textContent = 'Start logging your meals to see weekly nutrition insights!';
        return;
    }
    
    const daysWithData = weeklyData.filter(day => day.calories > 0);
    if (daysWithData.length === 0) {
        document.getElementById('weeklyInsights').textContent = 'No nutrition data logged this week. Start tracking your meals!';
        return;
    }
    
    const avgCalories = daysWithData.reduce((sum, day) => sum + day.calories, 0) / daysWithData.length;
    const avgProtein = daysWithData.reduce((sum, day) => sum + day.protein, 0) / daysWithData.length;
    const goalCalories = 2000; // Default goal
    const goalProtein = 150; // Default goal
    
    let insights = [];
    
    if (avgCalories < goalCalories * 0.8) {
        insights.push('You\'re eating below your calorie target. Consider adding healthy snacks.');
    } else if (avgCalories > goalCalories * 1.2) {
        insights.push('You\'re eating above your calorie target. Focus on portion control.');
    } else {
        insights.push('Great job maintaining your calorie target this week!');
    }
    
    if (avgProtein < goalProtein * 0.8) {
        insights.push('Your protein intake is low. Try adding more lean meats, eggs, or legumes.');
    } else if (avgProtein > goalProtein * 1.2) {
        insights.push('Your protein intake is high. This is fine if you\'re building muscle.');
    } else {
        insights.push('Excellent protein balance this week!');
    }
    
    if (daysWithData.length >= 5) {
        insights.push(`You tracked ${daysWithData.length} days this week - great consistency!`);
    } else {
        insights.push(`You tracked ${daysWithData.length} days. Try to log meals daily for better insights.`);
    }
    
    document.getElementById('weeklyInsights').textContent = insights.join(' ');
}

function createWeeklyChart(weeklyData) {
    try {
        console.log('Creating Chart.js weekly chart with data:', weeklyData);
        
        const chartContainer = document.getElementById('weeklyChart');
        
        // Check if canvas element exists
        if (!chartContainer) {
            console.error('Weekly chart canvas element not found');
            showChartLoading(false);
            showFallbackContent(weeklyData);
            return;
        }
        
        const labels = weeklyData.map(day => day.day_name);
        const datasets = getChartDatasets(weeklyData, currentChartType);
        
        // Comprehensive Chart.js availability check
        if (typeof Chart === 'undefined') {
            console.error('Chart.js library not loaded');
            showChartLoading(false);
            showFallbackContent(weeklyData);
            return;
        }
        
        // Additional check for Chart constructor
        if (typeof Chart !== 'function') {
            console.error('Chart constructor not available');
            showChartLoading(false);
            showFallbackContent(weeklyData);
            return;
        }
        
        // Test if Chart.js is actually working
        try {
            // Create a test chart to verify Chart.js is fully functional
            const testCanvas = document.createElement('canvas');
            testCanvas.width = 1;
            testCanvas.height = 1;
            const testChart = new Chart(testCanvas, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: { responsive: false }
            });
            testChart.destroy();
            console.log('Chart.js functionality confirmed');
        } catch (testError) {
            console.error('Chart.js functionality test failed:', testError);
            showChartLoading(false);
            showFallbackContent(weeklyData);
            return;
        }
        
        // Destroy existing chart if it exists and is a valid Chart.js instance
        if (window.weeklyChart && typeof window.weeklyChart.destroy === 'function') {
            try {
                window.weeklyChart.destroy();
                console.log('Previous chart destroyed successfully');
            } catch (destroyError) {
                console.warn('Error destroying previous chart:', destroyError);
            }
        } else if (window.weeklyChart) {
            console.warn('Previous chart exists but destroy method not available, clearing reference');
            window.weeklyChart = null;
        }
        
        // Create Chart.js configuration
        const config = {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: currentChartType === 'macros',
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        };
        
        // Create the chart
        try {
            // Clear any existing chart reference first
            if (window.weeklyChart) {
                window.weeklyChart = null;
            }
            
            // Create new chart instance
            window.weeklyChart = new Chart(chartContainer, config);
            
            // Verify the chart was created successfully
            if (window.weeklyChart && typeof window.weeklyChart.destroy === 'function') {
                showChartLoading(false);
                console.log('Chart.js chart created successfully');
            } else {
                throw new Error('Chart instance created but destroy method not available');
            }
        } catch (chartError) {
            console.error('Error creating Chart.js instance:', chartError);
            window.weeklyChart = null; // Clear invalid reference
            showChartLoading(false);
            showFallbackContent(weeklyData);
        }
        
    } catch (error) {
        console.error('Error creating Chart.js chart:', error);
        showChartLoading(false);
        showFallbackContent(weeklyData);
    }
}

function showFallbackContent(weeklyData) {
    const chartContainer = document.getElementById('weeklyChart');
    const avgCalories = Math.round(weeklyData.reduce((sum, day) => sum + day.calories, 0) / 7);
    const avgProtein = Math.round(weeklyData.reduce((sum, day) => sum + day.protein, 0) / 7);
    
    chartContainer.innerHTML = `
        <div class="h-64 flex items-center justify-center text-gray-500">
            <div class="text-center">
                <i class="fas fa-chart-line text-4xl mb-2 opacity-50"></i>
                <p class="font-medium text-gray-700 mb-2">Weekly Nutrition Summary</p>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-emerald-50 p-3 rounded-lg">
                        <div class="text-2xl font-bold text-emerald-600">${avgCalories}</div>
                        <div class="text-emerald-700">Avg Calories</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${avgProtein}g</div>
                        <div class="text-blue-700">Avg Protein</div>
                    </div>
                </div>
                <div class="mt-4 text-xs text-gray-500">
                    <p>Daily breakdown available in the data below</p>
                </div>
                <div class="mt-2 text-xs text-yellow-600">
                    <p>Chart.js failed to load. <button onclick="retryChartJS()" class="text-blue-600 underline">Click here to retry</button></p>
                </div>
            </div>
        </div>
    `;
}

function getChartDatasets(weeklyData, chartType) {
    const colors = {
        calories: '#10b981',
        protein: '#3b82f6',
        carbs: '#f59e0b',
        fat: '#ef4444'
    };
    
    switch (chartType) {
        case 'calories':
            return [{
                label: 'Calories',
                data: weeklyData.map(day => day.calories),
                borderColor: colors.calories,
                backgroundColor: colors.calories + '20',
                fill: true,
                tension: 0.4
            }];
        
        case 'macros':
            return [
                {
                    label: 'Protein (g)',
                    data: weeklyData.map(day => day.protein),
                    borderColor: colors.protein,
                    backgroundColor: colors.protein + '20',
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Carbs (g)',
                    data: weeklyData.map(day => day.carbs),
                    borderColor: colors.carbs,
                    backgroundColor: colors.carbs + '20',
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Fat (g)',
                    data: weeklyData.map(day => day.fat),
                    borderColor: colors.fat,
                    backgroundColor: colors.fat + '20',
                    fill: false,
                    tension: 0.4
                }
            ];
        
        case 'goals':
            return [
                {
                    label: 'Actual Calories',
                    data: weeklyData.map(day => day.calories),
                    borderColor: colors.calories,
                    backgroundColor: colors.calories + '20',
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Goal Calories',
                    data: weeklyData.map(() => 2000), // Default goal
                    borderColor: '#6b7280',
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0
                }
            ];
        
        default:
            return [];
    }
}

function switchChart(chartType) {
    currentChartType = chartType;
    
    // Update button styles
    const buttons = ['caloriesChartBtn', 'macrosChartBtn', 'goalsChartBtn'];
    buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btnId === chartType + 'ChartBtn') {
            btn.className = 'px-3 py-1 text-sm font-medium rounded-lg bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition-colors';
        } else {
            btn.className = 'px-3 py-1 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors';
        }
    });
    
    // Safely destroy existing chart before creating new one
    destroyWeeklyChart();
    
    // Update chart if data is available
    if (weeklyData) {
        createWeeklyChart(weeklyData);
    }
}

// Refresh weekly data when new meals are added
function refreshWeeklyProgress() {
    loadWeeklyProgress();
}

// Test function to manually check custom chart
function testCustomChart() {
    console.log('Testing custom chart availability...');
    if (typeof CustomChart !== 'undefined') {
        console.log(' Custom chart is available');
        
        // Test with sample data
        const testContainer = document.createElement('div');
        testContainer.style.width = '100px';
        testContainer.style.height = '100px';
        document.body.appendChild(testContainer);
        
        try {
            const testChart = new CustomChart(testContainer, {
                labels: ['Mon', 'Tue', 'Wed'],
                datasets: [{
                    label: 'Test',
                    data: [10, 20, 15]
                }]
            });
            console.log(' Custom chart test created successfully');
            document.body.removeChild(testContainer);
        } catch (error) {
            console.error(' Custom chart test failed:', error);
        }
    } else {
        console.log(' Custom chart is not available');
    }
}

// Test function to check Chart.js availability
function testChartJS() {
    console.log('Testing Chart.js availability...');
    console.log('Chart type:', typeof Chart);
    console.log('Chart constructor:', typeof Chart === 'function' ? 'Available' : 'Not available');
    
    if (typeof Chart !== 'undefined' && typeof Chart === 'function') {
        console.log(' Chart.js is available and ready to use');
        
        // Test if we can create a simple chart
        const testCanvas = document.createElement('canvas');
        testCanvas.width = 100;
        testCanvas.height = 100;
        document.body.appendChild(testCanvas);
        
        try {
            const testChart = new Chart(testCanvas, {
                type: 'line',
                data: {
                    labels: ['Test'],
                    datasets: [{
                        label: 'Test',
                        data: [1]
                    }]
                }
            });
            console.log(' Chart.js test chart created successfully');
            testChart.destroy();
            document.body.removeChild(testCanvas);
        } catch (error) {
            console.error(' Chart.js test chart failed:', error);
        }
    } else {
        console.log(' Chart.js is not available');
        console.log('Attempting to reload Chart.js...');
        loadChartJSFromCDN();
    }
}

// Retry function for custom chart
function retryCustomChart() {
    console.log('Retrying custom chart creation...');
    if (weeklyData) {
        createWeeklyChart(weeklyData);
    } else {
        loadWeeklyProgress();
    }
}

// Global retry function for Chart.js (can be called from browser console)
function retryChartJS() {
    console.log('Manually retrying Chart.js loading...');
    loadChartJSFromCDN();
    setTimeout(() => {
        if (typeof Chart !== 'undefined') {
            console.log('Chart.js loaded successfully, retrying chart creation...');
            if (weeklyData) {
                createWeeklyChart(weeklyData);
            } else {
                loadWeeklyProgress();
            }
        } else {
            console.error('Chart.js still not available after manual retry');
        }
    }, 2000);
}

// Global function to safely destroy weekly chart
function destroyWeeklyChart() {
    if (window.weeklyChart && typeof window.weeklyChart.destroy === 'function') {
        try {
            window.weeklyChart.destroy();
            console.log('Weekly chart destroyed successfully');
        } catch (error) {
            console.warn('Error destroying weekly chart:', error);
        }
    }
    window.weeklyChart = null;
}

// Global function to check chart instance health
function checkChartHealth() {
    console.log('Chart instance check:');
    console.log('- window.weeklyChart exists:', !!window.weeklyChart);
    console.log('- window.weeklyChart type:', typeof window.weeklyChart);
    if (window.weeklyChart) {
        console.log('- destroy method available:', typeof window.weeklyChart.destroy === 'function');
        console.log('- chart instance properties:', Object.keys(window.weeklyChart));
    }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (document.getElementById('mealPlanSlider')) {
        if (e.key === 'ArrowLeft') {
            previousDay();
        } else if (e.key === 'ArrowRight') {
            nextDay();
        }
    }
});

// Export nutrition data function
async function exportNutritionData(format) {
    try {
        const url = `/api/export/nutrition/member?format=${format}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error('Failed to export nutrition data');
        }
        
        // Create a temporary link to download the file
        const blob = await response.blob();
        const url2 = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url2;
        a.download = `member_nutrition_${new Date().toISOString().split('T')[0]}.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url2);
        document.body.removeChild(a);
        
    } catch (error) {
        console.error('Error exporting nutrition data:', error);
        alert('Failed to export nutrition data. Please try again.');
    }
}

// AI Meal Planner Functions
function openAIMealPlanModal() {
    document.getElementById('aiMealPlanModal').classList.remove('hidden');
}

function openAICustomMealModal() {
    document.getElementById('aiCustomMealModal').classList.remove('hidden');
}

// Handle AI Meal Plan Form Submission
document.getElementById('aiMealPlanForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('generateMealPlanBtn');
    const originalText = submitBtn.innerHTML;
    
    try {
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
        submitBtn.disabled = true;
        
        // Get form data
        const formData = new FormData(this);
        const planName = formData.get('plan_name');
        const userProfile = {
            age: parseInt(formData.get('age')),
            gender: formData.get('gender'),
            weight: parseFloat(formData.get('weight')),
            height: parseFloat(formData.get('height')),
            activity_level: formData.get('activity_level'),
            goal: formData.get('goal'),
            dietary_restrictions: formData.get('dietary_restrictions') || '',
            allergies: formData.get('allergies') || '',
            preferences: formData.get('preferences') || ''
        };
        
        // Call AI meal plan API
        const response = await fetch('/api/nutrition/generate-meal-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                user_profile: userProfile,
                plan_name: planName
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to generate meal plan');
        }
        
        const mealPlan = await response.json();
        
        // Show results
        showAIMealPlanResults(mealPlan);
        
        // Close the form modal
        closeModal('aiMealPlanModal');
        
    } catch (error) {
        console.error('Error generating meal plan:', error);
        alert('Error: ' + error.message);
    } finally {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// Handle AI Custom Meal Form Submission
document.getElementById('aiCustomMealForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('generateCustomMealBtn');
    const originalText = submitBtn.innerHTML;
    
    try {
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
        submitBtn.disabled = true;
        
        // Get form data
        const formData = new FormData(this);
        const mealRequirements = {
            meal_type: formData.get('meal_type'),
            cuisine_style: formData.get('cuisine_style') || '',
            calorie_range: formData.get('calorie_range'),
            dietary_preferences: formData.get('dietary_preferences') || '',
            include_ingredients: formData.get('include_ingredients') || '',
            exclude_ingredients: formData.get('exclude_ingredients') || ''
        };
        
        // Call AI custom meal API
        const response = await fetch('/api/nutrition/generate-custom-meal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ meal_requirements: mealRequirements })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to generate custom meal');
        }
        
        const customMeal = await response.json();
        
        // Show results
        showAICustomMealResults(customMeal);
        
        // Close the form modal
        closeModal('aiCustomMealModal');
        
    } catch (error) {
        console.error('Error generating custom meal:', error);
        alert('Error: ' + error.message);
    } finally {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// Show AI Meal Plan Results
function showAIMealPlanResults(mealPlan) {
    const resultsContainer = document.getElementById('aiMealPlanResults');
    
    // Get the plan name from the form
    const planNameInput = document.querySelector('#aiMealPlanForm input[name="plan_name"]');
    const planName = planNameInput ? planNameInput.value : 'Your Personalized Meal Plan';
    
    let html = `
        <div class="mb-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 border border-purple-100">
            <h4 class="text-lg font-semibold text-purple-800 mb-2">${planName}</h4>
            <p class="text-purple-700">Based on your profile and preferences, here's your complete 7-day meal plan:</p>
        </div>
    `;
    
    // Add nutritional targets if available
    if (mealPlan.nutritional_needs) {
        const needs = mealPlan.nutritional_needs;
        html += `
            <div class="mb-6 bg-white rounded-lg border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-3">
                    <h5 class="font-semibold">Daily Nutritional Targets</h5>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${needs.daily_calories || 2000}</div>
                            <div class="text-sm text-purple-700">Daily Calories</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${needs.daily_protein || 150}g</div>
                            <div class="text-sm text-blue-700">Daily Protein</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${needs.daily_carbs || 250}g</div>
                            <div class="text-sm text-green-700">Daily Carbs</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600">${needs.daily_fat || 70}g</div>
                            <div class="text-sm text-orange-700">Daily Fat</div>
                        </div>
                    </div>
                    ${needs.bmr ? `
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="text-center">
                                    <div class="text-lg font-semibold text-gray-700">${needs.bmr}</div>
                                    <div class="text-gray-600">BMR (Basal Metabolic Rate)</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-semibold text-gray-700">${needs.tdee}</div>
                                    <div class="text-gray-600">TDEE (Total Daily Energy Expenditure)</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Add each day
    for (let i = 1; i <= 7; i++) {
        const day = mealPlan.meal_plan[`day_${i}`];
        if (day) {
            html += `
                <div class="mb-6 bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-3">
                        <h5 class="font-semibold">Day ${i}</h5>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${generateMealHTML(day.breakfast, 'Breakfast')}
                            ${generateMealHTML(day.lunch, 'Lunch')}
                            ${generateMealHTML(day.dinner, 'Dinner')}
                            ${generateMealHTML(day.snack_1, 'Snack 1')}
                            ${generateMealHTML(day.snack_2, 'Snack 2')}
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // Add shopping list if available
    if (mealPlan.shopping_list) {
        html += `
            <div class="mb-6 bg-white rounded-lg border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-3">
                    <h5 class="font-semibold">Shopping List</h5>
                </div>
                <div class="p-4">
                    <ul class="space-y-2">
                        ${mealPlan.shopping_list.map(item => `<li class="flex items-center"><i class="fas fa-check text-emerald-600 mr-2"></i>${item}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    }
    
    // Add meal prep tips if available
    if (mealPlan.meal_prep_tips) {
        html += `
            <div class="mb-6 bg-white rounded-lg border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-3">
                    <h5 class="font-semibold">Meal Prep Tips</h5>
                </div>
                <div class="p-4">
                    <ul class="space-y-2">
                        ${mealPlan.meal_prep_tips.map(tip => `<li class="flex items-start"><i class="fas fa-lightbulb text-blue-600 mr-2 mt-1"></i>${tip}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    }
    
    resultsContainer.innerHTML = html;
    document.getElementById('aiMealPlanResultsModal').classList.remove('hidden');
}

// Show AI Custom Meal Results
function showAICustomMealResults(customMeal) {
    const resultsContainer = document.getElementById('aiCustomMealResults');
    
    let html = `
        <div class="mb-6 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border border-emerald-100">
            <h4 class="text-lg font-semibold text-emerald-800 mb-2">Custom Meal Ideas</h4>
            <p class="text-emerald-700">Based on your preferences, here are some meal suggestions:</p>
        </div>
    `;
    
    if (customMeal.meals && customMeal.meals.length > 0) {
        customMeal.meals.forEach((meal, index) => {
            html += `
                <div class="mb-4 bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-3">
                        <h5 class="font-semibold">Meal Idea ${index + 1}</h5>
                    </div>
                    <div class="p-4">
                        ${generateMealHTML(meal, 'Custom Meal')}
                    </div>
                </div>
            `;
        });
    } else {
        // Fallback meals when AI doesn't return results
        const fallbackMeals = getFallbackMeals();
        html += `
            <div class="mb-4 bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                <div class="flex items-center mb-2">
                    <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>
                    <span class="text-sm font-medium text-yellow-800">AI suggestions not available. Here are some healthy meal ideas:</span>
                </div>
            </div>
        `;
        
        fallbackMeals.forEach((meal, index) => {
            html += `
                <div class="mb-4 bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-4 py-3">
                        <h5 class="font-semibold">Healthy Meal Idea ${index + 1}</h5>
                    </div>
                    <div class="p-4">
                        ${generateMealHTML(meal, 'Fallback Meal')}
                    </div>
                </div>
            `;
        });
    }
    
    resultsContainer.innerHTML = html;
    document.getElementById('aiCustomMealResultsModal').classList.remove('hidden');
}

// Fallback meals function
function getFallbackMeals() {
    const fallbackMeals = [
        {
            name: "Mediterranean Quinoa Bowl",
            ingredients: [
                "1 cup cooked quinoa",
                "1/2 cup cherry tomatoes, halved",
                "1/4 cup cucumber, diced",
                "1/4 cup red onion, finely chopped",
                "1/4 cup kalamata olives, sliced",
                "2 tbsp feta cheese, crumbled",
                "2 tbsp extra virgin olive oil",
                "1 tbsp lemon juice",
                "1 tsp dried oregano",
                "Salt and pepper to taste"
            ],
            nutrition: {
                calories: 320,
                protein: 12,
                carbs: 45,
                fat: 14
            }
        },
        {
            name: "Grilled Chicken with Roasted Vegetables",
            ingredients: [
                "6 oz boneless, skinless chicken breast",
                "1 cup broccoli florets",
                "1 cup cauliflower florets",
                "1/2 cup carrots, sliced",
                "2 tbsp olive oil",
                "1 tsp garlic powder",
                "1 tsp paprika",
                "Salt and pepper to taste",
                "1 tbsp fresh herbs (rosemary, thyme, or parsley)"
            ],
            nutrition: {
                calories: 380,
                protein: 35,
                carbs: 18,
                fat: 16
            }
        },
        {
            name: "Protein-Packed Greek Yogurt Parfait",
            ingredients: [
                "1 cup Greek yogurt (2% fat)",
                "1/4 cup granola",
                "1/4 cup mixed berries (strawberries, blueberries, raspberries)",
                "1 tbsp honey",
                "1 tbsp chopped almonds",
                "1 tsp chia seeds"
            ],
            nutrition: {
                calories: 280,
                protein: 22,
                carbs: 32,
                fat: 8
            }
        },
        {
            name: "Asian-Inspired Salmon with Brown Rice",
            ingredients: [
                "5 oz salmon fillet",
                "1/2 cup cooked brown rice",
                "1 cup steamed bok choy",
                "1/4 cup edamame",
                "2 tbsp soy sauce (low sodium)",
                "1 tbsp sesame oil",
                "1 tsp ginger, minced",
                "1 clove garlic, minced",
                "1 tbsp sesame seeds"
            ],
            nutrition: {
                calories: 420,
                protein: 38,
                carbs: 35,
                fat: 18
            }
        },
        {
            name: "Vegetarian Lentil Curry",
            ingredients: [
                "1/2 cup cooked lentils",
                "1/2 cup cooked basmati rice",
                "1/4 cup coconut milk",
                "1/2 cup spinach",
                "1/4 cup diced tomatoes",
                "1/4 cup diced onions",
                "1 tsp curry powder",
                "1/2 tsp turmeric",
                "1/2 tsp cumin",
                "1 tbsp olive oil",
                "Salt to taste"
            ],
            nutrition: {
                calories: 350,
                protein: 16,
                carbs: 55,
                fat: 12
            }
        }
    ];
    
    // Return 3 random meals from the fallback list
    const shuffled = fallbackMeals.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 3);
}

// Delete nutrition plan function
async function deleteNutritionPlan(planId, planName) {
    if (!confirm(`Are you sure you want to delete the plan "${planName}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/member/nutrition/plans/${planId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to delete nutrition plan');
        }
        
        const result = await response.json();
        
        // Show success message
        alert('Nutrition plan deleted successfully!');
        
        // Refresh the nutrition plans modal
        viewMyNutritionPlans();
        
    } catch (error) {
        console.error('Error deleting nutrition plan:', error);
        alert('Error: ' + error.message);
    }
}

// Helper function to generate meal HTML
function generateMealHTML(meal, mealType) {
    if (!meal || !meal.name) {
        return `
            <div class="bg-gray-50 rounded-lg p-3">
                <h6 class="font-medium text-gray-700 mb-2">${mealType}</h6>
                <p class="text-gray-500 text-sm">No meal data available</p>
            </div>
        `;
    }
    
    const nutrition = meal.nutrition || {};
    const ingredients = meal.ingredients || [];
    
    return `
        <div class="bg-gray-50 rounded-lg p-3">
            <h6 class="font-medium text-gray-700 mb-2">${mealType}</h6>
            <h6 class="font-semibold text-gray-900 mb-2">${meal.name}</h6>
            
            ${ingredients.length > 0 ? `
                <div class="mb-2">
                    <p class="text-xs font-medium text-gray-600 mb-1">Ingredients:</p>
                    <ul class="text-xs text-gray-600 space-y-1">
                        ${ingredients.map(ingredient => `<li> ${ingredient}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <div class="grid grid-cols-2 gap-2 text-xs">
                <div class="bg-purple-100 rounded p-2">
                    <div class="font-medium text-purple-800">${nutrition.calories || 0}</div>
                    <div class="text-purple-600">calories</div>
                </div>
                <div class="bg-blue-100 rounded p-2">
                    <div class="font-medium text-blue-800">${nutrition.protein || 0}g</div>
                    <div class="text-blue-600">protein</div>
                </div>
                <div class="bg-orange-100 rounded p-2">
                    <div class="font-medium text-orange-800">${nutrition.carbs || 0}g</div>
                    <div class="text-orange-600">carbs</div>
                </div>
                <div class="bg-red-100 rounded p-2">
                    <div class="font-medium text-red-800">${nutrition.fat || 0}g</div>
                    <div class="text-red-600">fat</div>
                </div>
            </div>
        </div>
    `;
}
</script>

{% endblock %} 