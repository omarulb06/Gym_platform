{% extends "base.html" %}

{% block title %}My Schedule - PowerFit{% endblock %}

{% block content %}
    <!-- Upcoming Sessions -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">My Schedule</h3>
            <div id="schedule" class="space-y-6">
                <!-- Schedule will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Session Details Modal -->
    <div id="sessionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Session Details</h3>
                <div class="mt-2 px-7 py-3">
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm text-gray-500">Session Type</p>
                            <p class="text-base font-medium text-gray-900" id="modalSessionType">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Date & Time</p>
                            <p class="text-base font-medium text-gray-900" id="modalDateTime">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Duration</p>
                            <p class="text-base font-medium text-gray-900" id="modalDuration">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Status</p>
                            <p class="text-base font-medium text-gray-900" id="modalStatus">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Notes</p>
                            <p class="text-base font-medium text-gray-900" id="modalNotes">-</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-4">
                    <button onclick="closeSessionModal()" 
                            class="px-4 py-2 bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    const sessionModal = document.getElementById('sessionModal');
    let currentSession = null;

    // Show session modal
    function showSessionModal(session) {
        currentSession = session;
        
        // Format date and time
        let dateTime = '';
        try {
            if (session.session_date && session.session_time) {
                const dateStr = `${session.session_date}T${session.session_time}:00`;
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const formattedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const formattedTime = date.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    dateTime = `${formattedDate} at ${formattedTime}`;
                }
            }
        } catch (error) {
            console.error('Error formatting date/time:', error);
        }
        
        // Update modal content
        document.getElementById('modalSessionType').textContent = session.session_type || 'Regular';
        document.getElementById('modalDateTime').textContent = dateTime || 'Date and time not available';
        document.getElementById('modalDuration').textContent = `${session.duration || 60} minutes`;
        document.getElementById('modalStatus').textContent = session.status || 'Scheduled';
        
        // Handle notes display
        const notesElement = document.getElementById('modalNotes');
        if (session.notes && session.notes.trim() !== '') {
            notesElement.textContent = session.notes;
        } else {
            notesElement.textContent = 'No notes';
        }
        
        // Set status color
        const statusElement = document.getElementById('modalStatus');
        statusElement.className = 'text-base font-medium ' + 
            (session.status === 'Completed' ? 'text-green-600' : 
             session.status === 'Cancelled' ? 'text-red-600' : 
             'text-blue-600');
        
        sessionModal.classList.remove('hidden');
    }

    // Close session modal
    function closeSessionModal() {
        sessionModal.classList.add('hidden');
        currentSession = null;
    }

    // Close modal when clicking outside
    sessionModal.addEventListener('click', (e) => {
        if (e.target === sessionModal) {
            closeSessionModal();
        }
    });

    // Load schedule
    async function loadSchedule() {
        try {
            const response = await fetch('/api/member/schedule');
            const schedule = await response.json();
            
            const scheduleDiv = document.getElementById('schedule');
            if (Object.keys(schedule).length === 0) {
                scheduleDiv.innerHTML = '<p class="text-gray-500">No upcoming sessions scheduled.</p>';
                return;
            }

            scheduleDiv.innerHTML = Object.entries(schedule).map(([date, sessions]) => {
                // Format the date header
                let formattedHeaderDate = date;
                try {
                    const headerDate = new Date(date + 'T00:00:00');
                    if (!isNaN(headerDate.getTime())) {
                        formattedHeaderDate = headerDate.toLocaleDateString('en-US', {
                            weekday: 'long',
                            month: 'long',
                            day: 'numeric',
                            year: 'numeric'
                        });
                    }
                } catch (error) {
                    console.error('Error formatting header date:', error);
                }

                return `
                    <div class="mb-6">
                        <h4 class="text-md font-medium text-gray-700 mb-3">${formattedHeaderDate}</h4>
                        <div class="space-y-3">
                            ${sessions.map(session => {
                                // Format time
                                let formattedTime = '';
                                try {
                                    if (session.session_time) {
                                        const dateStr = `${session.session_date}T${session.session_time}:00`;
                                        const date = new Date(dateStr);
                                        if (!isNaN(date.getTime())) {
                                            formattedTime = date.toLocaleTimeString('en-US', {
                                                hour: 'numeric',
                                                minute: '2-digit',
                                                hour12: true
                                            });
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error formatting time:', error);
                                }

                                return `
                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"
                                         onclick='showSessionModal(${JSON.stringify(session)})'>
                                        <div>
                                            <h4 class="font-medium text-gray-900">${session.session_type || 'Regular'}</h4>
                                            <p class="text-sm text-gray-500">${formattedTime || 'Time not available'}</p>
                                            <p class="text-xs text-gray-400">${session.duration || 60} minutes</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                                ${session.status === 'Completed' ? 'bg-green-100 text-green-800' : 
                                                  session.status === 'Cancelled' ? 'bg-red-100 text-red-800' : 
                                                  'bg-blue-100 text-blue-800'}">
                                                ${session.status}
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading schedule:', error);
        }
    }

    // Load schedule when page loads
    document.addEventListener('DOMContentLoaded', loadSchedule);
</script>
{% endblock %}

{% block sidebar %}
<a href="/member/dashboard" class="block py-2 px-4 hover:bg-indigo-700">
    <i class="fas fa-home mr-2"></i> Dashboard
</a>
<a href="/member/schedule" class="block py-2 px-4 bg-indigo-700">
    <i class="fas fa-calendar mr-2"></i> My Schedule
</a>
<a href="/member/progress" class="block py-2 px-4 hover:bg-indigo-700">
    <i class="fas fa-chart-line mr-2"></i> Progress
</a>
{% endblock %} 